<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ØªÛŒÙ…â€ŒÚ©Ø´ÛŒ Ø´Ø§Ù†Ø³ÛŒ ÙÙˆØªØ¨Ø§Ù„</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{--accent:#1db954;--card:rgba(255,255,255,0.06);--overlay:rgba(0,0,0,0.55)}
*{box-sizing:border-box} html,body{height:100%;margin:0;font-family:'Vazirmatn',Tahoma,Arial;direction:rtl}
body{
  background: linear-gradient(var(--overlay),var(--overlay)), url('bg.jpg') center/cover no-repeat fixed;
  color:#fff;padding:20px;
}
.container{max-width:1100px;margin:12px auto;display:grid;grid-template-columns:1fr 420px;gap:18px}
.header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.h1{font-size:20px;font-weight:700}
.card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
.left{min-height:480px}
.form-row{display:flex;gap:8px;align-items:center;margin-top:10px}
.input,select,button{padding:10px;border-radius:10px;border:0;background:rgba(255,255,255,0.04);color:#fff;font-size:15px}
.big{background:linear-gradient(90deg,var(--accent),#29a06a);border:none;padding:10px 14px;font-weight:700;cursor:pointer}
.small{font-size:13px;color:rgba(255,255,255,0.85)}
.live-list{max-height:380px;overflow:auto;margin-top:12px}
.part{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent)}
.role-keeper{color:#ffd166;font-weight:700}
.role-player{color:#b9f6ca}
.teams{margin-top:12px}
.team-card{background:rgba(0,0,0,0.35);padding:10px;border-radius:10px;margin-bottom:10px}
.subs{font-size:13px;color:#ddd;margin-top:8px}
.footer{grid-column:1/-1;text-align:center;margin-top:10px;color:rgba(255,255,255,0.6);font-size:13px}
@media(max-width:920px){.container{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="h1">âš½ ØªÛŒÙ…â€ŒÚ©Ø´ÛŒ Ø´Ø§Ù†Ø³ÛŒ ÙÙˆØªØ¨Ø§Ù„</div>
      <div class="small">Ù‡Ø± Ù†ÙØ± ÙÙ‚Ø· ÛŒÚ©â€ŒØ¨Ø§Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†Ø¯ â€” Ù„ÛŒØ³Øª Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
    </div>
    <div class="small">Ø¨Ø¯ÙˆÙ† Ø±Ù…Ø² â€” Ù‡Ù…Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ùˆ Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ Ú©Ù†Ù†Ø¯</div>
  </div>

  <!-- LEFT: Ø«Ø¨Øª Ù†Ø§Ù… -->
  <section class="card left">
    <h3 style="margin:0">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h3>
    <div class="small" style="margin-top:6px">Ù†Ø§Ù… Ùˆ Ù†Ù‚Ø´ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†Ø› Ù‡Ø± Ù†ÙØ± ÙÙ‚Ø· ÛŒÚ©â€ŒØ¨Ø§Ø±.</div>

    <div class="form-row">
      <input id="nameInput" class="input" placeholder="Ù†Ø§Ù… (Ù…Ø«Ù„Ø§Ù‹: Ø¹Ù„ÛŒ)" />
      <select id="roleSelect" class="input">
        <option value="player">âš½ Ø¨Ø§Ø²ÛŒÚ©Ù†</option>
        <option value="gk">ğŸ¥… Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†</option>
      </select>
      <button id="joinBtn" class="big">âœ… Ø«Ø¨Øª Ù†Ø§Ù…</button>
    </div>

    <div class="form-row" style="margin-top:12px;align-items:center">
      <div class="small">ØªØ¹Ø¯Ø§Ø¯ ØªÛŒÙ…â€ŒÙ‡Ø§:</div>
      <select id="teamsSelect" class="input" style="width:120px">
        <option value="2">2 ØªÛŒÙ…</option>
        <option value="3">3 ØªÛŒÙ…</option>
        <option value="4">4 ØªÛŒÙ…</option>
      </select>
      <button id="setTeamsBtn" class="input" style="width:140px">ØªÙ†Ø¸ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡</button>
      <div style="flex:1"></div>
      <div class="small">ÙˆØ¶Ø¹ÛŒØª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: <span id="signupStatus">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span></div>
    </div>

    <div style="margin-top:12px;font-weight:700">Ù„ÛŒØ³Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (Ø²Ù†Ø¯Ù‡)</div>
    <div id="participants" class="live-list"></div>

    <div class="teams" id="teamsArea"></div>
  </section>

  <!-- RIGHT: Ú©Ù†ØªØ±Ù„ Ø¹Ù…ÙˆÙ…ÛŒ -->
  <aside class="card">
    <h3 style="margin:0">Ú©Ù†ØªØ±Ù„</h3>
    <div class="small" style="margin-top:8px">Ø¯Ú©Ù…Ù‡Ù” Ø´Ø±ÙˆØ¹ ØªÙ‚Ø³ÛŒÙ… ØªÛŒÙ…â€ŒÙ‡Ø§ (Ø¨Ø¯ÙˆÙ† Ø±Ù…Ø²):</div>
    <div style="margin-top:10px;display:flex;gap:8px">
      <button id="drawBtn" class="big" style="flex:1">ğŸ² Ø´Ø±ÙˆØ¹ Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ Ùˆ Ù†Ù…Ø§ÛŒØ´ ØªÛŒÙ…â€ŒÙ‡Ø§</button>
    </div>

    <div style="margin-top:12px" class="small">
      ØªÙˆØ¶ÛŒØ­: Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ (Reset) Ø¨Ø¹Ø¯ Ø§Ø² Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ Ø¨Ø§ÛŒØ¯ Ø§Ø² Ú©Ù†Ø³ÙˆÙ„ Firebase Ù…Ø³ÛŒØ± <code>rooms/main</code> Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ ØªØ§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…â€ŒÙ‡Ø§ Ùˆ ØªÛŒÙ…â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯.
    </div>

    <div style="margin-top:12px;font-weight:700">Ø¢Ù…Ø§Ø±</div>
    <div class="small" style="margin-top:6px">ØªØ¹Ø¯Ø§Ø¯ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡: <span id="count">0</span></div>
    <div class="small" style="margin-top:6px">ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†â€ŒÙ‡Ø§: <span id="gkcount">0</span></div>
  </aside>

  <div class="footer">Ø¢Ù…Ø§Ø¯Ù‡ Ùˆ Ø³Ø§Ø¯Ù‡ â€” Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡Ù” Ø¯ÙˆØ³ØªØ§Ù†Ù‡. (Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØª/Ù…Ø­ØµÙˆÙ„ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø² Firebase Auth Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†)</div>
</div>

<!-- firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ======= CONFIG: Ù…Ù‚Ø§Ø¯ÛŒØ± Firebase Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ =======
  Ø§Ø² Firebase Console -> Project settings -> Add web app -> copy config
  Ù…Ø«Ø§Ù„:
  const FIREBASE_CONFIG = {
    apiKey: "....",
    authDomain: "yourproj.firebaseapp.com",
    databaseURL: "https://yourproj-default-rtdb.firebaseio.com",
    projectId: "yourproj",
    storageBucket: "yourproj.appspot.com",
    messagingSenderId: "...",
    appId: "1:..."
  };
*/
const FIREBASE_CONFIG = {
  apiKey: "PUT_YOUR_apiKey",
  authDomain: "PUT_YOUR_project.firebaseapp.com",
  databaseURL: "https://PUT_YOUR_project-default-rtdb.firebaseio.com",
  projectId: "PUT_YOUR_project",
  storageBucket: "PUT_YOUR_project.appspot.com",
  messagingSenderId: "PUT_YOUR_messagingSenderId",
  appId: "PUT_YOUR_appId"
};
/* ======= end CONFIG ======= */

firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();

// room refs
const ROOM = 'main';
const participantsRef = db.ref(`rooms/${ROOM}/participants`);
const settingsRef = db.ref(`rooms/${ROOM}/settings`);
const teamsRef = db.ref(`rooms/${ROOM}/teams`);

// local client id to prevent double-register on same device
let CLIENT_ID = localStorage.getItem('ts_client_id');
if(!CLIENT_ID){ CLIENT_ID = 'c_' + Math.random().toString(36).slice(2,10); localStorage.setItem('ts_client_id', CLIENT_ID); }

// DOM
const nameInput = document.getElementById('nameInput');
const roleSelect = document.getElementById('roleSelect');
const joinBtn = document.getElementById('joinBtn');
const participantsEl = document.getElementById('participants');
const signupStatus = document.getElementById('signupStatus');
const teamsSelect = document.getElementById('teamsSelect');
const setTeamsBtn = document.getElementById('setTeamsBtn');
const drawBtn = document.getElementById('drawBtn');
const teamsArea = document.getElementById('teamsArea');
const countSpan = document.getElementById('count');
const gkSpan = document.getElementById('gkcount');

// utilities
function el(tag, html){ const d = document.createElement(tag); d.innerHTML = html; return d; }
function show(msg){ alert(msg); }
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

// read settings and participants live
settingsRef.on('value', snap=>{
  const s = snap.val() || {};
  const open = (s.signupOpen === undefined) ? true : !!s.signupOpen;
  signupStatus.textContent = open ? 'Ø¨Ø§Ø²' : 'Ø¨Ø³ØªÙ‡';
  if(s.teamsCount) teamsSelect.value = s.teamsCount;
});
participantsRef.on('value', snap=>{
  const obj = snap.val() || {};
  renderParticipants(obj);
});
teamsRef.on('value', snap=>{
  const t = snap.val();
  renderTeams(t);
});

// render
function renderParticipants(obj){
  participantsEl.innerHTML = '';
  const list = Object.entries(obj).map(([id, v]) => ({id, ...v}));
  list.sort((a,b) => (a.ts||0) - (b.ts||0));
  countSpan.textContent = list.length;
  gkSpan.textContent = list.filter(x=>x.role==='gk').length;
  if(list.length===0){ participantsEl.innerHTML = '<div class="small">Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª</div>'; return; }
  for(const p of list){
    const div = document.createElement('div'); div.className='part';
    const left = document.createElement('div'); left.innerHTML = `<strong>${escapeHtml(p.name)}</strong>`;
    const right = document.createElement('div'); right.innerHTML = `<span class="${p.role==='gk'?'role-keeper':'role-player'}">${p.role==='gk'?'ğŸ¥… Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†':'âš½ Ø¨Ø§Ø²ÛŒÚ©Ù†'}</span>`;
    if(p.clientId === CLIENT_ID) left.innerHTML += ' <small>(Ø´Ù…Ø§)</small>';
    div.appendChild(left); div.appendChild(right);
    participantsEl.appendChild(div);
  }
}

function renderTeams(obj){
  teamsArea.innerHTML = '';
  if(!obj) return;
  const keys = Object.keys(obj).filter(k=>k.startsWith('team')).sort();
  if(keys.length===0) return;
  const h = el('div','<h3>Ù†ØªÛŒØ¬Ù‡Ù” ØªÛŒÙ…â€ŒØ¨Ù†Ø¯ÛŒ</h3>'); teamsArea.appendChild(h);
  for(const k of keys){
    const t = obj[k];
    const card = document.createElement('div'); card.className='team-card';
    const title = document.createElement('div'); title.innerHTML = `<strong>${k.replace('team','ØªÛŒÙ… ')}</strong>`;
    card.appendChild(title);
    if(t.members && t.members.length){
      for(const m of t.members){
        const r = document.createElement('div'); r.style.marginTop='6px'; r.innerHTML = `${m.role==='gk'?'ğŸ§¤':'âš½'} &nbsp; <strong>${escapeHtml(m.name)}</strong>`;
        card.appendChild(r);
      }
    }
    if(t.subs && t.subs.length){
      const s = document.createElement('div'); s.className='subs'; s.innerHTML = `<em>ğŸ”„ ØªØ¹ÙˆÛŒØ¶ÛŒâ€ŒÙ‡Ø§:</em> ${ t.subs.map(x=>escapeHtml(x.name)).join(' ØŒ ') }`;
      card.appendChild(s);
    }
    teamsArea.appendChild(card);
  }
}

// escape
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// registration
joinBtn.addEventListener('click', async ()=>{
  const name = (nameInput.value||'').trim();
  const role = roleSelect.value;
  if(!name) return show('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù…ØªØ§Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
  // check signup open
  const meta = (await settingsRef.once('value')).val() || {};
  if(meta.assigned){ return show('Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡ â€” Ø«Ø¨Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ø³ØªÙ‡ Ø§Ø³Øª'); }
  const signupOpen = (meta.signupOpen === undefined) ? true : !!meta.signupOpen;
  if(!signupOpen) return show('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¨Ø³ØªÙ‡ Ø§Ø³Øª');
  // check if this client already registered (by CLIENT_ID)
  const existing = (await participantsRef.child(CLIENT_ID).once('value')).val();
  if(existing) return show('Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ (Ø±ÙˆÛŒ Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡).');
  // also prevent same name duplication (optional)
  const all = (await participantsRef.once('value')).val() || {};
  for(const k in all){ if(all[k].name === name){ return show('Ø§ÛŒÙ† Ù†Ø§Ù… Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³ØªØ› Ø§Ø³Ù… Ø¯ÛŒÚ¯Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†'); } }
  // write
  const rec = { clientId: CLIENT_ID, name, role, ts: Date.now() };
  await participantsRef.child(CLIENT_ID).set(rec);
  nameInput.value = '';
  show('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ âœ…');
});

// set teams count (for everyone)
setTeamsBtn.addEventListener('click', async ()=>{
  const n = Number(teamsSelect.value || 2);
  await settingsRef.update({ teamsCount: n });
  show('ØªØ¹Ø¯Ø§Ø¯ ØªÛŒÙ…â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯: ' + n);
});

// draw / assign teams (public)
drawBtn.addEventListener('click', async ()=>{
  // read participants and settings
  const participants = (await participantsRef.once('value')).val() || {};
  const list = Object.values(participants);
  const settings = (await settingsRef.once('value')).val() || {};
  const teamsCount = Number(settings.teamsCount || teamsSelect.value || 2);
  if(list.length === 0) return show('Ù‡ÛŒÚ† Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
  const gks = list.filter(x=>x.role==='gk');
  const players = list.filter(x=>x.role!=='gk');
  if(gks.length < teamsCount) return show(`ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†â€ŒÙ‡Ø§ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª â€” Ø­Ø¯Ø§Ù‚Ù„ ${teamsCount} Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù† Ù„Ø§Ø²Ù… Ø§Ø³Øª`);
  // shuffle
  shuffleArray(gks); shuffleArray(players);
  // prepare teams
  const teams = Array.from({length: teamsCount}, ()=>({ members: [], subs: [] }));
  // assign GK per team
  for(let i=0;i<teamsCount;i++){ teams[i].members.push({ id: gks[i].clientId, name: gks[i].name, role:'gk' }); }
  // assign players round-robin while keeping max 5
  let idx = 0;
  for(const p of players){
    let placed = false;
    for(let attempt=0; attempt<teamsCount; attempt++){
      const ti = (idx + attempt) % teamsCount;
      if(teams[ti].members.length < 5){
        teams[ti].members.push({ id: p.clientId, name: p.name, role:'player' });
        placed = true; idx = ti + 1; break;
      }
    }
    if(!placed){
      // push to smallest subs
      let minS = Infinity, pick = 0;
      for(let j=0;j<teamsCount;j++){
        if(teams[j].subs.length < minS){ minS = teams[j].subs.length; pick = j; }
      }
      teams[pick].subs.push({ id: p.clientId, name: p.name, role:'player' });
    }
    idx++;
  }
  // write to DB
  const out = {};
  for(let i=0;i<teams.length;i++){ out['team'+i] = teams[i]; }
  await teamsRef.set(out);
  await settingsRef.update({ assigned: true, assignedAt: Date.now(), teamsCount });
  show('Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ â€” ØªÛŒÙ…â€ŒÙ‡Ø§ Ù…Ù†ØªØ´Ø± Ø´Ø¯Ù†Ø¯ âœ…');
});

// initial defaults: set settings if empty
(async ()=>{
  const s = (await settingsRef.once('value')).val();
  if(!s) await settingsRef.set({ teamsCount: 2, signupOpen: true, assigned: false });
})();
</script>
</body>
</html>
