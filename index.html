<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ØªÛŒÙ…â€ŒÚ©Ø´ÛŒ Ø´Ø§Ù†Ø³ÛŒ ÙÙˆØªØ¨Ø§Ù„ â€” Ø¯Ùˆ ØªÛŒÙ…</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{--accent:#1db954;--card:rgba(255,255,255,0.06);--overlay:rgba(0,0,0,0.56)}
*{box-sizing:border-box} html,body{height:100%;margin:0;font-family:'Vazirmatn',Tahoma,Arial;direction:rtl}
body{
  background: linear-gradient(var(--overlay),var(--overlay)), url('bg.jpg') center/cover no-repeat fixed;
  color:#fff;padding:18px;
}
.container{max-width:1000px;margin:12px auto;display:grid;grid-template-columns:1fr 360px;gap:16px}
.header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.h1{font-size:20px;font-weight:700}
.card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 22px rgba(0,0,0,0.5)}
.left{min-height:520px}
.form-row{display:flex;gap:8px;align-items:center;margin-top:10px}
.input,select,button{text-align:center;padding:10px;border-radius:10px;border:0;background:rgba(255,255,255,0.04);color:#fff;font-size:15px}
.big{background:linear-gradient(90deg,var(--accent),#29a06a);border:none;padding:12px 14px;font-weight:700;cursor:pointer}
.small{font-size:13px;color:rgba(255,255,255,0.85)}
.live-list{max-height:320px;overflow:auto;margin-top:12px}
.part{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent)}
.role-keeper{color:#ffd166;font-weight:700}
.role-player{color:#b9f6ca}
.teams{margin-top:12px}
.team-card{background:rgba(0,0,0,0.35);padding:10px;border-radius:10px;margin-bottom:10px}
.subs{font-size:13px;color:#ddd;margin-top:8px}
.modal {
  position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999;
}
.modal-card{background:#0b0b0b;border-radius:12px;padding:18px;width:360px;text-align:center}
.spin-ball{width:96px;height:96px;margin:0 auto 12px;display:flex;align-items:center;justify-content:center}
.ball{width:72px;height:72px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #fff 0%, #eee 25%, #000 26%, #000 27%, #fff 27%);position:relative;animation:spin 1.2s linear infinite}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
.confirm {background:linear-gradient(90deg,#00e676,#00c853);color:#002;padding:12px;border-radius:10px;margin-top:12px;font-weight:700}
.badge{background:rgba(255,255,255,0.04);padding:6px 10px;border-radius:10px}
.footer{grid-column:1/-1;text-align:center;margin-top:10px;color:rgba(255,255,255,0.6);font-size:13px}
@media(max-width:900px){.container{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="h1">âš½ ØªÛŒÙ…â€ŒÚ©Ø´ÛŒ Ø´Ø§Ù†Ø³ÛŒ â€” Û² ØªÛŒÙ…</div>
      <div class="small">Ø¨Ø§Ø²ÛŒÚ©Ù†ØŒ Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù† Ùˆ ØªØ¹ÙˆÛŒØ¶ÛŒ â€” Ù‡Ù…Ù‡ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ù†Ø¯</div>
    </div>
    <div class="small">Ù‡Ø± Ú©Ø§Ø±Ø¨Ø± ÙÙ‚Ø· ÛŒÚ©â€ŒØ¨Ø§Ø± Ø§Ø² Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡</div>
  </div>

  <!-- LEFT -->
  <section class="card left">
    <h3 style="margin:0">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø³Ø±ÛŒØ¹</h3>
    <div class="small" style="margin-top:6px">ÙØ§Ù…ÛŒÙ„ÛŒØª Ø±Ùˆ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù† (ÙÙ‚Ø· Ø­Ø±ÙˆÙ Ù„Ø§ØªÛŒÙ† Ùˆ ÙØ§ØµÙ„Ù‡ Ù…Ø¬Ø§Ø²).</div>

    <div style="margin-top:12px">
      <input id="familyInput" class="input" placeholder="Ù…Ø«Ø§Ù„: Amiri" style="width:60%" />
      <div style="display:inline-block;width:8px"></div>
      <button id="nextBtn" class="big" style="width:32%">Ø¨Ø¹Ø¯ÛŒ â–¶</button>
    </div>

    <!-- role / register area -->
    <div id="roleArea" style="display:none;margin-top:14px">
      <div class="small">Ù†Ù‚Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="rolePlayer" class="input" style="flex:1">ğŸ‘Ÿ Ø¨Ø§Ø²ÛŒÚ©Ù†</button>
        <button id="roleGk" class="input" style="flex:1">ğŸ¥… Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†</button>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="registerBtn" class="big" style="flex:1">âœ… Ø«Ø¨Øª Ùˆ Ù¾ÛŒÙˆØ³ØªÙ†</button>
      </div>
    </div>

    <div style="margin-top:18px;font-weight:700">Ù„ÛŒØ³Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (Ø²Ù†Ø¯Ù‡)</div>
    <div id="participants" class="live-list"></div>

    <div class="teams" id="teamsArea"></div>
  </section>

  <!-- RIGHT -->
  <aside class="card">
    <h3 style="margin:0">ÙˆØ¶Ø¹ÛŒØª Ø¯Ùˆ ØªÛŒÙ… (Ø²Ù†Ø¯Ù‡)</h3>
    <div class="small" style="margin-top:8px">Ø¬Ø¯ÙˆÙ„ ØªÛŒÙ…â€ŒÙ‡Ø§ Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ Ù¾Ø³ Ø§Ø² Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
    <div style="margin-top:12px;font-weight:700">Ø¢Ù…Ø§Ø±</div>
    <div class="small" style="margin-top:8px">Ú©Ù„ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡: <span id="count">0</span></div>
    <div class="small" style="margin-top:6px">Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†â€ŒÙ‡Ø§: <span id="gkcount">0</span></div>
    <div style="margin-top:12px" class="small">Ù‚ÙˆØ§Ø¹Ø¯: 2 ØªÛŒÙ… â€” Ù‡Ø± ØªÛŒÙ… ØªØ§ Ûµ Ù†ÙØ± (Ø´Ø§Ù…Ù„ GK) â€” Ø§Ø¶Ø§ÙÛŒâ€ŒÙ‡Ø§ ØªØ¹ÙˆÛŒØ¶ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
  </aside>

  <div class="footer">Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ (Reset) Ø¨Ø¹Ø¯ Ø§Ø² Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§ÛŒØ¯ Ø§Ø² Firebase Console Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯.</div>
</div>

<!-- modal on load -->
<div id="welcomeModal" class="modal" style="display:flex">
  <div class="modal-card">
    <div class="spin-ball"><div class="ball" title="soccer"></div></div>
    <div style="font-weight:800;font-size:18px">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒ Ø¨Ù‡ ØªÛŒÙ…â€ŒÚ©Ø´ÛŒ Ø´Ø§Ù†Ø³ÛŒ</div>
    <div class="small" style="margin-top:8px">ÙØ§Ù…ÛŒÙ„ÛŒØª Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ØŒ Ù†Ù‚Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† Ùˆ Ø«Ø¨Øª Ø´Ùˆ â€” Ù‡Ù…Ù‡ Ø¯Ø± Ù„Ø­Ø¸Ù‡ Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ù†Ø¯.</div>
    <div style="margin-top:12px">
      <button id="modalClose" class="big">Ø´Ø±ÙˆØ¹ Ú©Ù†</button>
    </div>
  </div>
</div>

<!-- firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ====== CONFIG: Ù…Ù‚Ø¯Ø§Ø±Ù‡Ø§ÛŒ Firebase Ø±Ø§ Ø§Ø² Ú©Ù†Ø³ÙˆÙ„ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§Øª Ú©Ù¾ÛŒ Ú©Ù† Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¨Ø¯Ù‡ ====== */
const FIREBASE_CONFIG = {
  apiKey: "PUT_YOUR_apiKey",
  authDomain: "PUT_YOUR_project.firebaseapp.com",
  databaseURL: "https://PUT_YOUR_project-default-rtdb.firebaseio.com",
  projectId: "PUT_YOUR_project",
  storageBucket: "PUT_YOUR_project.appspot.com",
  messagingSenderId: "PUT_YOUR_messagingSenderId",
  appId: "PUT_YOUR_appId"
};
/* ===================================================================================== */
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();

// room refs
const ROOM = 'main';
const participantsRef = db.ref(`rooms/${ROOM}/participants`);
const teamsRef = db.ref(`rooms/${ROOM}/teams`);
const settingsRef = db.ref(`rooms/${ROOM}/settings`);

// local client id to block double registration on same device
let CLIENT_ID = localStorage.getItem('ts_client_id_v2');
if(!CLIENT_ID){ CLIENT_ID = 'c_' + Math.random().toString(36).slice(2,10); localStorage.setItem('ts_client_id_v2', CLIENT_ID); }

// DOM
const welcomeModal = document.getElementById('welcomeModal');
const modalClose = document.getElementById('modalClose');
const familyInput = document.getElementById('familyInput');
const nextBtn = document.getElementById('nextBtn');
const roleArea = document.getElementById('roleArea');
const rolePlayer = document.getElementById('rolePlayer');
const roleGk = document.getElementById('roleGk');
const registerBtn = document.getElementById('registerBtn');
const participantsEl = document.getElementById('participants');
const teamsArea = document.getElementById('teamsArea');
const countSpan = document.getElementById('count');
const gkSpan = document.getElementById('gkcount');

// behavior for modal
modalClose.addEventListener('click', ()=> { welcomeModal.style.display = 'none'; familyInput.focus(); });

// next button -> show role selection (validate english)
nextBtn.addEventListener('click', ()=>{
  const v = (familyInput.value||'').trim();
  if(!v) return alert('Ù„Ø·ÙØ§Ù‹ ÙØ§Ù…ÛŒÙ„ÛŒØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');
  // validate English letters, spaces, hyphen and apostrophe
  if(!/^[A-Za-z\s'-]+$/.test(v)) return alert('ÙÙ‚Ø· Ø§Ø² Ø­Ø±ÙˆÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† (A-Z) Ùˆ ÙØ§ØµÙ„Ù‡/ - / \' Ù…Ø¬Ø§Ø² Ø§Ø³Øª.');
  roleArea.style.display = 'block';
  rolePlayer.classList.remove('selected'); roleGk.classList.remove('selected');
});

// visual selection
let selectedRole = 'player';
rolePlayer.addEventListener('click', ()=> { selectedRole='player'; rolePlayer.style.background='rgba(255,255,255,0.08)'; roleGk.style.background='transparent'; });
roleGk.addEventListener('click', ()=> { selectedRole='gk'; roleGk.style.background='rgba(255,255,255,0.08)'; rolePlayer.style.background='transparent'; });

// register
registerBtn.addEventListener('click', async ()=>{
  const name = (familyInput.value||'').trim();
  if(!name) return alert('Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');
  // check local client already registered
  const existing = (await participantsRef.child(CLIENT_ID).once('value')).val();
  if(existing) return alert('Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ (Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡).');
  // also check if registration already locked by assigned flag? we allow until any time
  // build record
  const rec = { clientId: CLIENT_ID, name, role: selectedRole, ts: Date.now() };
  await participantsRef.child(CLIENT_ID).set(rec);
  // show big confirmation card
  showConfirmation(name, selectedRole);
  familyInput.value = '';
  roleArea.style.display = 'none';
  // recompute teams automatically
  await recomputeTeams();
});

// realtime listeners
participantsRef.on('value', snap => {
  const obj = snap.val() || {};
  renderParticipants(obj);
  // after updating participants, recompute teams (defensive) to keep live consistent
  recomputeTeams().catch(e=>console.warn('recomputeTeams err', e));
});
teamsRef.on('value', snap => { renderTeams(snap.val()); });

// render participants
function renderParticipants(obj){
  participantsEl.innerHTML = '';
  const list = Object.entries(obj||{}).map(([id,v])=>({id, ...v}));
  list.sort((a,b)=> (a.ts||0) - (b.ts||0));
  countSpan.textContent = list.length;
  gkSpan.textContent = list.filter(x=>x.role==='gk').length;
  if(list.length===0){ participantsEl.innerHTML = '<div class="small">ÙØ¹Ù„Ø§Ù‹ Ú©Ø³ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª</div>'; return; }
  for(const p of list){
    const d = document.createElement('div'); d.className='part';
    const left = document.createElement('div'); left.innerHTML = `<strong>${escapeHtml(p.name)}</strong>` + (p.clientId===CLIENT_ID ? ' <small>(Ø´Ù…Ø§)</small>' : '');
    const right = document.createElement('div'); right.innerHTML = `<span class="${p.role==='gk'?'role-keeper':'role-player'}">${p.role==='gk'?'ğŸ¥… Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†':'âš½ Ø¨Ø§Ø²ÛŒÚ©Ù†'}</span>`;
    d.appendChild(left); d.appendChild(right);
    participantsEl.appendChild(d);
  }
}

// render teams
function renderTeams(obj){
  teamsArea.innerHTML = '';
  // we expect team0 and team1 keys
  if(!obj) return;
  const keys = ['team0','team1'];
  for(let i=0;i<keys.length;i++){
    const t = obj[keys[i]] || {members:[], subs:[]};
    const card = document.createElement('div'); card.className='team-card';
    const title = document.createElement('div'); title.innerHTML = `<strong>ØªÛŒÙ… ${i+1} â€” ${ (t.members? t.members.length:0) } Ù†ÙØ±</strong>`;
    card.appendChild(title);
    if(t.members && t.members.length){
      for(const m of t.members){
        const row = document.createElement('div'); row.style.marginTop='6px';
        row.innerHTML = `${m.role==='gk'?'ğŸ§¤':'âš½'} &nbsp; <strong>${escapeHtml(m.name)}</strong>`;
        card.appendChild(row);
      }
    } else {
      const emptyLine = document.createElement('div'); emptyLine.style.marginTop='8px'; emptyLine.innerHTML = `<em style="opacity:0.9">â€” (Ø®Ø§Ù„ÛŒ)</em>`; card.appendChild(emptyLine);
    }
    if(t.subs && t.subs.length){
      const subs = document.createElement('div'); subs.className='subs';
      subs.innerHTML = `<em>ğŸ”„ ØªØ¹ÙˆÛŒØ¶ÛŒâ€ŒÙ‡Ø§:</em> ${ t.subs.map(x=>escapeHtml(x.name)).join(' ØŒ ') }`;
      card.appendChild(subs);
    }
    teamsArea.appendChild(card);
  }
}

// helper escape
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// show confirmation big card
function showConfirmation(name, role){
  const modal = document.createElement('div'); modal.className='modal';
  const card = document.createElement('div'); card.className='modal-card';
  const icon = document.createElement('div'); icon.className='spin-ball'; icon.innerHTML = `<div style="width:64px;height:64px;border-radius:8px;background:linear-gradient(90deg,#fff,#eee);display:flex;align-items:center;justify-content:center;color:#002;font-weight:800">âœ…</div>`;
  const text = document.createElement('div'); text.style.marginTop='8px'; text.innerHTML = `<strong>Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯</strong><div style="margin-top:8px">${escapeHtml(name)} â€” ${role==='gk' ? 'ğŸ¥… Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†' : 'âš½ Ø¨Ø§Ø²ÛŒÚ©Ù†'}</div>`;
  card.appendChild(icon); card.appendChild(text);
  modal.appendChild(card); document.body.appendChild(modal);
  setTimeout(()=>{ modal.remove(); }, 1600);
}

// core: recompute teams automatically based on all participants
async function recomputeTeams(){
  try {
    const participants = (await participantsRef.once('value')).val() || {};
    const list = Object.values(participants);
    // always 2 teams
    const teamsCount = 2;
    // separate gks and players
    const gks = list.filter(x=>x.role==='gk');
    const players = list.filter(x=>x.role!=='gk');
    // shuffle both lists
    shuffleArray(gks); shuffleArray(players);
    // prepare teams
    const teams = Array.from({length:teamsCount}, ()=>({ members: [], subs: [] }));
    // assign gks to teams if available; if not enough, leave empty
    for(let i=0;i<teamsCount;i++){
      if(gks[i]) teams[i].members.push({ id: gks[i].clientId, name: gks[i].name, role:'gk' });
      // else leave empty slot (no gk)
    }
    // assign players round-robin while respecting max 5 per team (including GK)
    let idx = 0;
    for(const p of players){
      let placed = false;
      for(let attempt=0; attempt<teamsCount; attempt++){
        const tIdx = (idx + attempt) % teamsCount;
        const currentCount = teams[tIdx].members.length;
        if(currentCount < 5){
          teams[tIdx].members.push({ id: p.clientId, name: p.name, role:'player' });
          placed = true; idx = tIdx + 1; break;
        }
      }
      if(!placed){
        // all teams full -> put into subs with smallest subs
        let minSubs = Infinity, pick = 0;
        for(let j=0;j<teamsCount;j++){
          if(teams[j].subs.length < minSubs){ minSubs = teams[j].subs.length; pick = j; }
        }
        teams[pick].subs.push({ id: p.clientId, name: p.name, role:'player' });
      }
      idx++;
    }
    // balance attempt (should usually be balanced already)
    // write to DB (atomic overwrite)
    const out = { team0: teams[0], team1: teams[1] };
    await teamsRef.set(out);
    // also save settings meta
    await settingsRef.update({ teamsCount: teamsCount, lastUpdated: Date.now() });
  } catch(err) {
    console.error('recomputeTeams error', err);
  }
}

// initial: ensure settings default
(async ()=>{
  const s = (await settingsRef.once('value')).val();
  if(!s) settingsRef.set({ teamsCount: 2, signupOpen: true, assigned: false });
})();
</script>
</body>
</html>
