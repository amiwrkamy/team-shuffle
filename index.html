<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Team Maker â€” Pro Design</title>
<style>
/* ---------- theme ---------- */
:root{
  --bg-dark:#071022;
  --panel:#0b1a2b;
  --glass: rgba(255,255,255,0.04);
  --neon-1:#6ee7b7; /* mint */
  --neon-2:#60a5fa; /* blue */
  --neon-3:#fcbf49; /* gold */
  --neon-4:#f472b6; /* pink */
  --muted: rgba(255,255,255,0.7);
  --card-shadow: 0 20px 60px rgba(2,6,23,0.7);
  --glass-border: rgba(255,255,255,0.03);
  font-family: Vazirmatn, "Segoe UI", Tahoma, sans-serif;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* ---------- base ---------- */
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:
  radial-gradient(1200px 400px at 10% 10%, rgba(96,165,250,0.06), transparent 8%),
  radial-gradient(900px 300px at 90% 90%, rgba(252,191,73,0.03), transparent 8%),
  var(--bg-dark);
  color:#e6f0ff;
}
.app{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}

/* ---------- container 3D ---------- */
.shell{width:100%;max-width:1100px;perspective:1400px}
.panel{
  transform-style:preserve-3d;
  border-radius:18px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  box-shadow:var(--card-shadow), inset 0 1px 0 rgba(255,255,255,0.02);
  border:1px solid var(--glass-border);
  transition:transform .28s cubic-bezier(.2,.9,.2,1);
}
.panel:hover{transform:translateY(-8px) rotateX(1deg)}

/* ---------- header ---------- */
.head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.brand{font-weight:900;font-size:20px;letter-spacing:.6px;background:linear-gradient(90deg,var(--neon-2),var(--neon-1));-webkit-background-clip:text;background-clip:text;color:transparent}
.sub{font-size:13px;color:var(--muted)}

/* ---------- layout ---------- */
.grid{display:grid;grid-template-columns:1fr 420px;gap:14px}
@media(max-width:920px){ .grid{grid-template-columns:1fr} }

/* ---------- form ---------- */
.card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.05));padding:14px;border-radius:12px}
.field{margin-bottom:8px}
.input{
  width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);
  background:rgba(255,255,255,0.01);color:inherit;font-size:15px;
  outline:none;
}
.roles{display:flex;gap:8px;margin-top:8px}
.role{
  flex:1;padding:10px;border-radius:10px;text-align:center;font-weight:800;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.05));
  cursor:pointer;border:1px solid rgba(255,255,255,0.02);
}
.role.active{box-shadow:0 14px 40px rgba(96,165,250,0.08);transform:translateY(-4px);border-color:rgba(255,255,255,0.06)}

/* ---------- buttons 3D ---------- */
.btn{
  display:inline-block;padding:12px 14px;border-radius:12px;border:none;font-weight:900;cursor:pointer;margin-top:10px;width:100%;
  transform:translateZ(0);
}
.btn-primary{background:linear-gradient(90deg,var(--neon-2),var(--neon-1));color:#001;box-shadow:0 12px 30px rgba(96,165,250,0.12)}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)}
.btn-admin{background:linear-gradient(90deg,var(--neon-3),#ffd54f);color:#001}

/* ---------- teams ---------- */
.teams{display:flex;gap:12px;margin-top:12px}
@media(max-width:920px){ .teams{flex-direction:column} }
.team{
  flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));
  border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.02);
  min-height:140px;backdrop-filter: blur(6px)
}
.team h4{margin:0 0 8px;color:var(--neon-2);font-size:15px}
ul{list-style:none;padding:0;margin:0}
li{
  display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;margin-bottom:8px;
  background:linear-gradient(90deg, rgba(255,255,255,0.015), rgba(0,0,0,0.08));
  font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}

/* ---------- neon accents & lightning ---------- */
.lightning{position:absolute;left:0;top:0;right:0;height:4px;pointer-events:none;mix-blend-mode:screen}
.lightning:before{content:"";position:absolute;inset:0;background:linear-gradient(90deg, rgba(96,165,250,0.0), rgba(252,191,73,0.06), rgba(244,114,182,0.04));opacity:0.9;filter:blur(12px);transform:translateZ(0);animation:glow 3s linear infinite}
@keyframes glow{0%{filter:blur(8px);opacity:.6}50%{filter:blur(16px);opacity:1}100%{filter:blur(8px);opacity:.6}}

/* ---------- splash (transparent background) ---------- */
#splash{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:120;pointer-events:none;background:transparent;
}
#ball{font-size:110px;animation:ball-spin .5s ease-in-out both}
@keyframes ball-spin{0%{transform:rotate(0) scale(1);opacity:1}60%{transform:rotate(360deg) scale(1.18);opacity:1}100%{transform:rotate(720deg) scale(1);opacity:0}}

/* ---------- tiny toast ---------- */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:rgba(3,6,23,0.8);padding:10px 14px;border-radius:10px;color:#fff;z-index:200;display:none}
</style>
</head>
<body>

<div class="app">
  <div class="shell">
    <div class="panel">
      <div class="lightning" aria-hidden="true"></div>

      <div class="head">
        <div class="brand">TEAM MAKER PRO</div>
        <div class="sub" id="count">0 Ù†ÙØ±</div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="field">
            <input id="name" class="input" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù…â€ŒØ®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ (ÙØ§Ø±Ø³ÛŒ/Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)" maxlength="40" />
          </div>

          <div class="roles" role="radiogroup" aria-label="Ù†Ù‚Ø´">
            <div id="rolePlayer" class="role" role="radio" data-role="player" tabindex="0">âš½ Ø¨Ø§Ø²ÛŒÚ©Ù†</div>
            <div id="roleGk" class="role" role="radio" data-role="gk" tabindex="0">ğŸ§¤ Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†</div>
          </div>

          <button id="btnRegister" class="btn btn-primary">Ø«Ø¨Øª Ùˆ Ø¹Ø¶ÙˆÛŒØª</button>

          <div style="height:10px"></div>

          <button id="btnShuffle" class="btn btn-ghost">ğŸ”€ Ù‚Ø§Ø·ÛŒâ€ŒÚ©Ø±Ø¯Ù† Ø¯ÙˆØ¨Ø§Ø±Ù‡ (Ø§Ø¯Ù…ÛŒÙ†)</button>
          <button id="btnReset" class="btn btn-admin">ğŸ” Ø±ÛŒØ³Øª (Ø§Ø¯Ù…ÛŒÙ†)</button>
        </div>

        <div>
          <div class="teams">
            <div class="team" aria-live="polite">
              <h4>ğŸ”µ ØªÛŒÙ… A</h4>
              <ul id="teamA"></ul>
              <div style="height:8px"></div>
              <h4 style="font-size:13px;color:#ffd54f">ØªØ¹ÙˆÛŒØ¶ÛŒ A</h4>
              <ul id="subsA"></ul>
            </div>

            <div class="team" aria-live="polite">
              <h4>ğŸ”´ ØªÛŒÙ… B</h4>
              <ul id="teamB"></ul>
              <div style="height:8px"></div>
              <h4 style="font-size:13px;color:#ffd54f">ØªØ¹ÙˆÛŒØ¶ÛŒ B</h4>
              <ul id="subsB"></ul>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div id="splash" aria-hidden="true"><div id="ball">âš½</div></div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ---------- robust script ---------- */
(() => {
  'use strict';
  const ADMIN_PASS = 'admin12345';
  const STORAGE_KEY = 'TEAM_MAKER_PRO_V2';
  const DEVICE_KEY = 'TEAM_MAKER_DEV_V2';

  const refs = {
    name: document.getElementById('name'),
    rolePlayer: document.getElementById('rolePlayer'),
    roleGk: document.getElementById('roleGk'),
    btnRegister: document.getElementById('btnRegister'),
    btnShuffle: document.getElementById('btnShuffle'),
    btnReset: document.getElementById('btnReset'),
    teamA: document.getElementById('teamA'),
    teamB: document.getElementById('teamB'),
    subsA: document.getElementById('subsA'),
    subsB: document.getElementById('subsB'),
    count: document.getElementById('count'),
    splash: document.getElementById('splash'),
    toast: document.getElementById('toast')
  };

  // device id
  function getDevice(){
    try{
      let d = localStorage.getItem(DEVICE_KEY);
      if(!d){ d = Date.now().toString(36) + Math.random().toString(36).slice(2,8); localStorage.setItem(DEVICE_KEY, d); }
      return d;
    }catch(e){
      return 'dev-'+Math.random().toString(36).slice(2,8);
    }
  }
  const DEVICE = getDevice();

  // load/save
  function load(){
    try{ const s = localStorage.getItem(STORAGE_KEY); return s ? JSON.parse(s) : { players: [] }; }
    catch(e){ console.error('load err', e); return { players: [] }; }
  }
  function save(state){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){ console.error('save err', e); } }

  let state = load();

  // random helper (use crypto if available)
  function randInt(max){
    try{
      if(window.crypto && crypto.getRandomValues){
        const arr = new Uint32Array(1);
        crypto.getRandomValues(arr);
        return arr[0] % max;
      }
    }catch(e){}
    return Math.floor(Math.random()*max);
  }

  // splash removal after animationend
  (function handleSplash(){
    try{
      const s = refs.splash;
      if(!s) return;
      const ball = document.getElementById('ball');
      if(ball){
        ball.addEventListener('animationend', ()=>{ try{s.remove();}catch(e){} }, { once:true });
        // fallback
        setTimeout(()=>{ if(document.body.contains(s)) s.remove(); }, 900);
      } else {
        s.remove();
      }
    }catch(e){ console.error('splash err', e); }
  })();

  // UI helpers
  function toast(msg, ms=1600){
    try{
      refs.toast.textContent = msg; refs.toast.style.display='block';
      clearTimeout(refs._t); refs._t = setTimeout(()=>{ refs.toast.style.display='none'; }, ms);
    }catch(e){ console.log(msg); }
  }

  // role selection
  let selectedRole = null;
  function setRole(r){
    selectedRole = r;
    refs.rolePlayer.classList.toggle('active', r==='player');
    refs.roleGk.classList.toggle('active', r==='gk');
    refs.rolePlayer.setAttribute('aria-checked', r==='player');
    refs.roleGk.setAttribute('aria-checked', r==='gk');
  }
  refs.rolePlayer.addEventListener('click', ()=>setRole('player'));
  refs.roleGk.addEventListener('click', ()=>setRole('gk'));
  refs.rolePlayer.addEventListener('keypress', (e)=>{ if(e.key==='Enter') setRole('player'); });
  refs.roleGk.addEventListener('keypress', (e)=>{ if(e.key==='Enter') setRole('gk'); });

  // assignment rule: 2 teams, max 5 incl GK, GK max1 per team, extras -> subs balanced
  function assign(p, stateObj){
    const teams = { A: [], B: [] }, subs = { A: [], B: [] };
    for(const q of stateObj.players){
      if(q.team){
        if(q.sub) subs[q.team].push(q); else teams[q.team].push(q);
      }
    }
    // GK handling
    if(p.role === 'gk'){
      const hasA = teams.A.some(x=>x.role==='gk'), hasB = teams.B.some(x=>x.role==='gk');
      if(hasA && hasB) return { ok:false, reason:'gk_all' };
      const candidates = [];
      if(!hasA && teams.A.length < 5) candidates.push('A');
      if(!hasB && teams.B.length < 5) candidates.push('B');
      if(candidates.length === 0) return { ok:false, reason:'gk_no_space' };
      const pick = candidates[randInt(candidates.length)];
      p.team = pick; p.sub = false; return { ok:true, team: pick, as:'main' };
    }
    // player handling
    const aMain = teams.A.length, bMain = teams.B.length;
    const available = [];
    if(aMain < 5) available.push('A');
    if(bMain < 5) available.push('B');
    if(available.length > 0){
      const minMain = Math.min(aMain, bMain);
      const balanced = available.filter(t => (t==='A'?aMain:bMain) === minMain);
      const pick = balanced[randInt(balanced.length)];
      p.team = pick; p.sub = false; return { ok:true, team: pick, as:'main' };
    }
    // mains full -> subs to smaller subs
    const sa = subs.A.length, sb = subs.B.length;
    const pick = sa <= sb ? 'A' : 'B';
    p.team = pick; p.sub = true; return { ok:true, team: pick, as:'sub' };
  }

  // register handler
  refs.btnRegister.addEventListener('click', ()=>{
    try{
      const name = (refs.name.value || '').trim();
      if(!name) { toast('Ø§Ø³Ù… Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
      if(!selectedRole) { toast('Ù†Ù‚Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
      if(state.players.some(x=>x.device === DEVICE)) { toast('Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ø±Ø¯Ù‡'); return; }
      const player = { id: Date.now().toString(36)+Math.random().toString(36).slice(2,6), name, role: selectedRole, device: DEVICE };
      const res = assign(player, state);
      if(!res.ok){
        if(res.reason === 'gk_all') { toast('Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù† Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¯Ùˆ ØªÛŒÙ… Ø«Ø¨Øª Ø´Ø¯Ù‡'); return; }
        if(res.reason === 'gk_no_space') { toast('ÙØ¶Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù† Ù†ÛŒØ³Øª'); return; }
        toast('Ù‚Ø§Ø¨Ù„ÛŒØª Ø«Ø¨Øª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯'); return;
      }
      state.players.push(player); save(state); render(); refs.name.value=''; setRole(null); toast('Ø«Ø¨Øª Ø´Ø¯ âœ…');
    }catch(e){ console.error('register err', e); toast('Ø®Ø·Ø§ÛŒ Ø«Ø¨Øª'); }
  });

  // admin shuffle
  refs.btnShuffle.addEventListener('click', ()=>{
    try{
      const pass = prompt('Ø±Ù…Ø² Ø§Ø¯Ù…ÛŒÙ†:');
      if(pass === null) return;
      if(pass !== ADMIN_PASS){ toast('Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡'); return; }
      // require at least 2 GK to reshuffle
      const gks = state.players.filter(p=>p.role==='gk');
      if(gks.length < 2) { toast('Ø¨Ø±Ø§ÛŒ Ù‚Ø§Ø·ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø­Ø¯Ø§Ù‚Ù„ 2 Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù† Ù„Ø§Ø²Ù… Ø§Ø³Øª'); return; }
      // shuffle list strongly
      for(let i = state.players.length - 1; i > 0; i--){
        const j = randInt(i+1);
        [state.players[i], state.players[j]] = [state.players[j], state.players[i]];
      }
      // clear assignments
      for(const p of state.players){ delete p.team; delete p.sub; }
      // assign GK first
      const gkList = state.players.filter(p=>p.role==='gk');
      for(let i=0;i<2 && i<gkList.length;i++){
        gkList[i].team = i===0 ? 'A' : 'B'; gkList[i].sub = false;
      }
      // assign others in round-robin with constraints
      let rr = 0;
      for(const p of state.players.filter(x=>!x.team)){
        const aMain = state.players.filter(x=>x.team==='A' && !x.sub).length;
        const bMain = state.players.filter(x=>x.team==='B' && !x.sub).length;
        const prefer = rr % 2 === 0 ? 'A' : 'B';
        const alt = prefer === 'A' ? 'B' : 'A';
        if((prefer === 'A' && aMain < 5) || (prefer === 'B' && bMain < 5)) { p.team = prefer; p.sub = false; }
        else if((alt === 'A' && aMain < 5) || (alt === 'B' && bMain < 5)) { p.team = alt; p.sub = false; }
        else {
          const sa = state.players.filter(x=>x.team==='A' && x.sub).length;
          const sb = state.players.filter(x=>x.team==='B' && x.sub).length;
          p.team = sa <= sb ? 'A' : 'B'; p.sub = true;
        }
        rr++;
      }
      save(state); render(); toast('ØªÛŒÙ…â€ŒÙ‡Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø´Ø§Ù†Ø³ÛŒ Ú†ÛŒØ¯Ù‡ Ø´Ø¯Ù†Ø¯');
    }catch(e){ console.error('shuffle err', e); toast('Ø®Ø·Ø§'); }
  });

  // admin reset
  refs.btnReset.addEventListener('click', ()=>{
    try{
      const pass = prompt('Ø±Ù…Ø² Ø§Ø¯Ù…ÛŒÙ†:');
      if(pass === null) return;
      if(pass !== ADMIN_PASS){ toast('Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡'); return; }
      if(!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒ Ù‡Ù…Ù‡ Ú†ÛŒØ² Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ')) return;
      state = { players: [] }; save(state); localStorage.removeItem(DEVICE_KEY); render(); toast('Ù¾Ø§Ú© Ø´Ø¯');
    }catch(e){ console.error('reset err', e); toast('Ø®Ø·Ø§'); }
  });

  // render UI
  function render(){
    try{
      refs.teamA.innerHTML = ''; refs.teamB.innerHTML = ''; refs.subsA.innerHTML = ''; refs.subsB.innerHTML = '';
      // ensure assignment for any legacy players
      for(const p of state.players){ if(!p.team){ const tmp = assign({...p}, state); p.team = tmp.team; p.sub = tmp.as==='sub'; } }
      const A_main = state.players.filter(p=>p.team==='A' && !p.sub);
      const B_main = state.players.filter(p=>p.team==='B' && !p.sub);
      const A_subs = state.players.filter(p=>p.team==='A' && p.sub);
      const B_subs = state.players.filter(p=>p.team==='B' && p.sub);
      for(const p of A_main) refs.teamA.insertAdjacentHTML('beforeend', `<li><span style="min-width:26px;display:inline-block">${p.role==='gk'?'ğŸ§¤':'âš½'}</span>${escapeHtml(p.name)}</li>`);
      for(const p of B_main) refs.teamB.insertAdjacentHTML('beforeend', `<li><span style="min-width:26px;display:inline-block">${p.role==='gk'?'ğŸ§¤':'âš½'}</span>${escapeHtml(p.name)}</li>`);
      for(const p of A_subs) refs.subsA.insertAdjacentHTML('beforeend', `<li>ğŸ” ${escapeHtml(p.name)}</li>`);
      for(const p of B_subs) refs.subsB.insertAdjacentHTML('beforeend', `<li>ğŸ” ${escapeHtml(p.name)}</li>`);
      refs.count.textContent = `${state.players.length} Ù†ÙØ±`;
    }catch(e){ console.error('render err', e); }
  }

  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  // initial render
  render();

  // expose for debug
  window.TEAM_MAKER = { state, saveState: (s)=>{ state = s; save(state); render(); }, render };

})();
</script>
</body>
</html>
