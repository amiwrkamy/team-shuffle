<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Random Team â€” Live</title>

<!-- Firebase compat (Realtime DB) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  *{box-sizing:border-box;font-family: Vazirmatn, Tahoma, Arial; }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071233,#001428);color:#eef;display:flex;align-items:center;justify-content:center}
  #loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;z-index:999}
  .ball{font-size:88px;animation:spin .5s linear}
  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg);opacity:0}}
  .wrap{width:95%;max-width:980px;padding:18px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.18));box-shadow:0 30px 80px rgba(0,0,0,0.6)}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .admin-mini{display:flex;gap:8px}
  .admin-mini button{padding:6px 8px;border-radius:8px;border:none;background:#f6b500;color:#000;font-weight:700;cursor:pointer;font-size:13px;opacity:.9}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px}
  .input{width:100%;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,0.03);color:inherit;font-size:15px}
  .btn{width:100%;padding:12px;border-radius:10px;border:none;margin-top:10px;font-weight:800;cursor:pointer}
  .btn.player{background:linear-gradient(90deg,#2b8af6,#60a5fa);color:#fff}
  .btn.gk{background:linear-gradient(90deg,#fb6b6b,#e34b4b);color:#fff}
  .teams{display:flex;gap:12px}
  .team{flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));padding:10px;border-radius:10px;min-height:220px}
  .team h3{margin:6px 0 10px}
  .list{list-style:none;padding:0;margin:0;max-height:420px;overflow:auto}
  .item{padding:6px 8px;border-radius:8px;margin-bottom:6px;background:rgba(0,0,0,0.18);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sub{opacity:.9;color:#ffd166}
  .note{font-size:13px;color:rgba(255,255,255,0.7);margin-top:8px}
</style>
</head>
<body>

<div id="loader"><div class="ball">âš½</div></div>

<div class="wrap" id="app" style="display:none">
  <div class="header">
    <div style="font-weight:900;font-size:18px">Random Team â€” Ø²Ù†Ø¯Ù‡</div>
    <div class="admin-mini">
      <button id="btnShuffleTop" title="Shuffle (admin)">Mix</button>
      <button id="btnResetTop" title="Reset (admin)">Reset</button>
    </div>
  </div>

  <div class="grid">
    <!-- left: input -->
    <div>
      <div class="card">
        <div id="step1">
          <input id="nameInput" class="input" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (ÙØ§Ø±Ø³ÛŒ ÛŒØ§ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)">
          <div style="margin-top:8px;font-size:13px;color:rgba(255,255,255,0.75)">Ø§Ø³Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ØŒ Ø³Ù¾Ø³ Ù†Ù‚Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</div>
          <button id="nextBtn" class="btn" style="background:linear-gradient(90deg,#00c2a8,#1287ff);color:#001">Ø§Ø¯Ø§Ù…Ù‡</button>
        </div>

        <div id="step2" style="display:none">
          <div style="display:flex;gap:10px">
            <button id="btnPlayer" class="btn player">âš½ Ø¨Ø§Ø²ÛŒÚ©Ù†</button>
            <button id="btnGk" class="btn gk">ğŸ§¤ Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†</button>
          </div>
        </div>

        <div style="margin-top:12px" id="noteBox">
          <div class="note">ØªØ¹Ø¯Ø§Ø¯ Ø§ØµÙ„ÛŒ Ù‡Ø± ØªÛŒÙ… ØªØ§ Ûµ Ù†ÙØ± Ø§Ø³Øª (Ø´Ø§Ù…Ù„ GK). Ø§Ø¶Ø§ÙÙ‡â€ŒÙ‡Ø§ Ø¨Ù‡ ØªØ¹ÙˆÛŒØ¶ÛŒ Ù…ÛŒâ€ŒØ±ÙˆÙ†Ø¯.</div>
        </div>
      </div>
    </div>

    <!-- right: teams -->
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">ÙˆØ¶Ø¹ÛŒØª ØªÛŒÙ…â€ŒÙ‡Ø§</div>
          <div id="count" style="font-size:13px;color:rgba(255,255,255,0.8)">Û° Ù†ÙØ±</div>
        </div>
        <div style="height:12px"></div>
        <div class="teams">
          <div class="team">
            <h3>ğŸ”µ Team A</h3>
            <ul id="teamA" class="list"></ul>
            <div style="margin-top:8px;font-weight:700;color:#ffd166">ØªØ¹ÙˆÛŒØ¶ÛŒ A</div>
            <ul id="subA" class="list"></ul>
          </div>
          <div class="team">
            <h3>ğŸ”´ Team B</h3>
            <ul id="teamB" class="list"></ul>
            <div style="margin-top:8px;font-weight:700;color:#ffd166">ØªØ¹ÙˆÛŒØ¶ÛŒ B</div>
            <ul id="subB" class="list"></ul>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
  // ============== CONFIG: Ø¬Ø§ÛŒ firebaseConfig Ø®ÙˆØ¯ØªÙˆÙ† Ø±Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø°Ø§Ø±ÛŒØ¯ ==============
  const firebaseConfig = {
    apiKey: "PUT_YOUR_APIKEY",
    authDomain: "PUT_YOUR_AUTHDOMAIN",
    databaseURL: "PUT_YOUR_DBURL",
    projectId: "PUT_YOUR_PROJECTID",
  };
  // ===========================================================================

  // init firebase
  try {
    firebase.initializeApp(firebaseConfig);
  } catch (e) { console.error('firebase init err', e); alert('Firebase init error - check config'); }
  const db = firebase.database();

  // UI refs
  const loader = document.getElementById('loader');
  const app = document.getElementById('app');
  const nameInput = document.getElementById('nameInput');
  const nextBtn = document.getElementById('nextBtn');
  const step2 = document.getElementById('step2');
  const btnPlayer = document.getElementById('btnPlayer');
  const btnGk = document.getElementById('btnGk');
  const teamA = document.getElementById('teamA');
  const teamB = document.getElementById('teamB');
  const subA = document.getElementById('subA');
  const subB = document.getElementById('subB');
  const countEl = document.getElementById('count');
  const btnShuffleTop = document.getElementById('btnShuffleTop');
  const btnResetTop = document.getElementById('btnResetTop');

  const ADMIN_PASS = 'admin12345';
  const LOCAL_FLAG = 'rt_registered_v1';
  const TEAMS = 2;
  const MAX_MAIN = 5;

  function randInt(max){
    try{ const a = new Uint32Array(1); crypto.getRandomValues(a); return a[0] % max; } catch(e){ return Math.floor(Math.random()*max); }
  }
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){ const j = randInt(i+1); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr;
  }

  setTimeout(()=>{ loader.style.display='none'; app.style.display='block'; }, 600);

  nextBtn.addEventListener('click', ()=>{
    if(!nameInput.value.trim()){ alert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
    if(localStorage.getItem(LOCAL_FLAG)){
      nameInput.value = '';
      step2.style.display='none';
      nextBtn.style.display='none';
      return;
    }
    nextBtn.style.display='none';
    step2.style.display='block';
  });

  btnPlayer.addEventListener('click', ()=> registerRole('player'));
  btnGk.addEventListener('click', ()=> registerRole('goalkeeper'));

  function registerRole(role){
    const name = nameInput.value.trim();
    if(!name) { alert('Ù†Ø§Ù… ØªÙ‡ÛŒ Ø§Ø³Øª'); return; }
    if(localStorage.getItem(LOCAL_FLAG)){ alert('Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ú©Ø±Ø¯ÛŒØ¯'); return; }
    const ref = db.ref('players').push();
    ref.set({ name: name, role: role, ts: Date.now() }, (err)=>{
      if(err){ console.error('push err', err); alert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª â€” Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯'); }
      else {
        localStorage.setItem(LOCAL_FLAG, '1');
        document.getElementById('step1').style.display='none';
        step2.style.display='none';
        nameInput.value = '';
      }
    });
  }

  db.ref('players').on('value', snap=>{
    try{
      const arr = [];
      snap.forEach(ch=>{
        const v = ch.val();
        arr.push(Object.assign({}, v, { key: ch.key }));
      });
      const teams = assignTeams(arr);
      renderTeams(teams);
    } catch(e){
      console.error('on value err', e);
    }
  }, err => console.error('firebase on err', err));

  function assignTeams(list){
    const gks = list.filter(p => p.role === 'goalkeeper').slice();
    const players = list.filter(p => p.role !== 'goalkeeper').slice();
    shuffle(gks); shuffle(players);
    const teams = Array.from({length:TEAMS}, ()=>({ main:[], subs:[] }));
    for(let i=0;i<TEAMS;i++){ if(gks[i]) teams[i].main.push({ name: gks[i].name, role: 'gk' }); }
    let idx = 0;
    for(const p of players){
      let attempts = 0; let placed = false;
      while(attempts < TEAMS){
        const t = (idx + attempts) % TEAMS;
        if(teams[t].main.length < MAX_MAIN){
          teams[t].main.push({ name: p.name, role: 'player' });
          placed = true; break;
        }
        attempts++;
      }
      if(!placed){
        const subsLens = teams.map(t=>t.subs.length);
        const pick = subsLens[0] <= subsLens[1] ? 0 : 1;
        teams[pick].subs.push({ name: p.name, role: 'player' });
      }
      idx++;
    }
    for(const t of teams){ while(t.main.length > MAX_MAIN){ const moved = t.main.pop(); t.subs.push(moved); } }
    return teams;
  }

  function renderTeams(teams){
    teamA.innerHTML = ''; teamB.innerHTML=''; subA.innerHTML=''; subB.innerHTML='';
    teams[0].main.forEach(p=>{ const li = document.createElement('li'); li.className='item'; li.textContent = (p.role==='gk' ? 'ğŸ§¤ ' : 'âš½ ') + p.name; teamA.appendChild(li); });
    teams[0].subs.forEach(p=>{ const li = document.createElement('li'); li.className='item sub'; li.textContent = 'ğŸ” ' + p.name; subA.appendChild(li); });
    teams[1].main.forEach(p=>{ const li = document.createElement('li'); li.className='item'; li.textContent = (p.role==='gk' ? 'ğŸ§¤ ' : 'âš½ ') + p.name; teamB.appendChild(li); });
    teams[1].subs.forEach(p=>{ const li = document.createElement('li'); li.className='item sub'; li.textContent = 'ğŸ” ' + p.name; subB.appendChild(li); });
    const total = teams[0].main.length + teams[1].main.length + teams[0].subs.length + teams[1].subs.length;
    countEl.textContent = total + ' Ù†ÙØ±';
  }

  btnResetTop.addEventListener('click', ()=> adminAction('reset'));
  btnShuffleTop.addEventListener('click', ()=> adminAction('shuffle'));

  function adminAction(type){
    const pass = prompt('Ø±Ù…Ø² Ø§Ø¯Ù…ÛŒÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
    if(pass !== ADMIN_PASS){ alert('Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡'); return; }
    if(type === 'reset'){
      if(!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
      db.ref('players').remove().then(()=>{
        localStorage.removeItem(LOCAL_FLAG);
        alert('Ø±ÛŒØ³Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
      }).catch(err => { console.error(err); alert('Ø®Ø·Ø§ Ø¯Ø± Ø±ÛŒØ³Øª'); });
    } else if(type === 'shuffle'){
      db.ref('players').once('value').then(snap=>{
        const arr = [];
        snap.forEach(ch => { arr.push(ch.val()); });
        shuffle(arr);
        db.ref('players').remove().then(()=>{
          arr.forEach(p=> db.ref('players').push(p) );
          alert('Mix Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
        }).catch(err=>{ console.error('rewrite err', err); alert('Ø®Ø·Ø§ Ø¯Ø± Mix'); });
      }).catch(err => { console.error('once err', err); alert('Ø®Ø·Ø§ Ø¯Ø± Mix read'); });
    }
  }

  if(localStorage.getItem(LOCAL_FLAG)){ document.getElementById('step1').style.display='none'; step2.style.display='none'; }

  window.addEventListener('error', e => console.error('window error', e));
  window.addEventListener('unhandledrejection', e => console.error('promise rej', e));
</script>
</body>
</html>
