<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Shuffle â€” ØªÛŒÙ…â€ŒÚ©Ø´ÛŒ Ø´Ø§Ù†Ø³ÛŒ (Ø¯Ùˆ ØªÛŒÙ…)</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1: #06102b; /* dark navy */
  --bg2: #000814; /* black-blue */
  --accent1: #00b0ff; /* blue */
  --accent2: #ffd600; /* yellow */
  --accent3: #1db954; /* green */
  --accent4: #ff3b30; /* red */
  --card: rgba(255,255,255,0.04);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Vazirmatn',Tahoma,Arial;direction:rtl}
body{
  background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
  color:#fff;padding:18px;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
.container{max-width:1100px;margin:12px auto;display:grid;grid-template-columns:1fr 380px;gap:18px}
.header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.h1{font-size:20px;font-weight:700;color:var(--accent1)}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
.left{min-height:520px}
.form-row{display:flex;gap:8px;align-items:center;margin-top:10px}
.input,select,button{padding:10px;border-radius:10px;border:0;background:rgba(255,255,255,0.03);color:#fff;font-size:15px}
.big{background:linear-gradient(90deg,var(--accent1),#0066cc);border:none;padding:12px 14px;font-weight:700;cursor:pointer;color:#001}
.big:disabled{opacity:0.6;cursor:not-allowed}
.small{font-size:13px;color:rgba(255,255,255,0.8)}
.live-list{max-height:320px;overflow:auto;margin-top:12px}
.part{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;margin-bottom:10px;background:linear-gradient(90deg, rgba(0,0,0,0.25), rgba(255,255,255,0.01))}
.role-keeper{color:var(--accent2);font-weight:700}
.role-player{color:var(--accent3);font-weight:700}
.teams{margin-top:14px}
.team-card{background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(255,255,255,0.01));padding:12px;border-radius:10px;margin-bottom:12px; border: 1px solid rgba(255,255,255,0.03)}
.team-title{display:flex;align-items:center;gap:10px;font-weight:800}
.subs{font-size:13px;color:#ddd;margin-top:8px}
.footer{grid-column:1/-1;text-align:center;margin-top:10px;color:rgba(255,255,255,0.6);font-size:13px}

/* modal / welcome animation like telegram sticker */
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:linear-gradient(rgba(0,0,0,0.6),rgba(0,0,0,0.6));display:flex;align-items:center;justify-content:center;z-index:9999}
.modal-card{background:linear-gradient(180deg,#031028,#04112b);border-radius:16px;padding:22px;width:420px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.7)}
.ballWrap{width:140px;height:140px;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;position:relative}
.ballEmoji{
  font-size:72px; line-height:1; display:inline-block;
  transform-origin:center;
  animation: floaty 1.6s ease-in-out infinite, rotateBall 2.2s linear infinite;
  text-shadow: 0 6px 24px rgba(0,0,0,0.6);
}
@keyframes rotateBall { from{ transform: rotate(0deg)} to{ transform: rotate(360deg)} }
@keyframes floaty { 0%{transform:translateY(0)}50%{transform:translateY(-10px)}100%{transform:translateY(0)} }

.confirm {
  margin-top:12px;background:linear-gradient(90deg,var(--accent3),var(--accent1));color:#001;padding:12px;border-radius:12px;font-weight:800;box-shadow:0 6px 20px rgba(0,0,0,0.5);
}

/* mobile */
@media(max-width:980px){.container{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="h1">âš½ Team Shuffle â€” Ø¯Ùˆ ØªÛŒÙ… (Ø´Ø§Ù†Ø³ÛŒ)</div>
        <div class="small">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø³Ø§Ø¯Ù‡ â€” Ù‡Ù…Ù‡ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø¨Ø¨ÛŒÙ†Ù†Ø¯</div>
      </div>
      <div class="small">Ù‡Ø± Ù†ÙØ± ÙÙ‚Ø· ÛŒÚ©â€ŒØ¨Ø§Ø± (Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡)</div>
    </div>

    <!-- LEFT -->
    <section class="card left">
      <h3 style="margin:0">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø³Ø±ÛŒØ¹</h3>
      <div class="small" style="margin-top:6px">ÙØ§Ù…ÛŒÙ„ÛŒØª Ø±Ø§ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù† Ùˆ Ø¨Ø¹Ø¯ Ù†Ù‚Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.</div>

      <div class="form-row" style="margin-top:12px;">
        <input id="familyInput" class="input" placeholder="Ù…Ø«Ø§Ù„: Amiri" style="flex:1" />
        <button id="nextBtn" class="big" style="width:140px">Ø¨Ø¹Ø¯ÛŒ â–¶</button>
      </div>

      <div id="roleArea" style="display:none;margin-top:14px">
        <div class="small">Ù†Ù‚Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="rolePlayer" class="input" style="flex:1">ğŸ‘Ÿ Ø¨Ø§Ø²ÛŒÚ©Ù†</button>
          <button id="roleGk" class="input" style="flex:1">ğŸ¥… Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†</button>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="registerBtn" class="big" style="flex:1">âœ… Ø«Ø¨Øª Ùˆ Ù¾ÛŒÙˆØ³ØªÙ†</button>
        </div>
      </div>

      <div style="margin-top:18px;font-weight:700">Ù„ÛŒØ³Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (Ø²Ù†Ø¯Ù‡)</div>
      <div id="participants" class="live-list"></div>

      <div class="teams" id="teamsArea"></div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <h3 style="margin:0">ÙˆØ¶Ø¹ÛŒØª ØªÛŒÙ…â€ŒÙ‡Ø§</h3>
      <div class="small" style="margin-top:8px">Ø¯Ùˆ ØªÛŒÙ… â€” Ù‡Ø± ØªÛŒÙ… ØªØ§ Ûµ Ù†ÙØ± (Ø´Ø§Ù…Ù„ GK) â€” Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ ØªØ¹ÙˆÛŒØ¶ÛŒ</div>
      <div style="margin-top:12px;font-weight:700">Ø¢Ù…Ø§Ø±</div>
      <div class="small" style="margin-top:8px">Ú©Ù„ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡: <span id="count">0</span></div>
      <div class="small" style="margin-top:6px">Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†â€ŒÙ‡Ø§: <span id="gkcount">0</span></div>
      <div style="margin-top:14px">
        <button id="forceRecompute" class="input" style="width:100%">â™»ï¸ Ø¨Ø§Ø²Ú†ÛŒÙ†Ø´ Ø¯Ø³ØªÛŒ (Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²)</button>
      </div>
    </aside>

  </div>

  <!-- welcome modal -->
  <div id="welcomeModal" class="modal">
    <div class="modal-card">
      <div class="ballWrap"><div class="ballEmoji">âš½</div></div>
      <h2 style="margin:6px 0 0 0">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒ!</h2>
      <div class="small" style="margin-top:8px">ÙØ§Ù…ÛŒÙ„ÛŒØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ØŒ Ù†Ù‚Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† Ùˆ Ø«Ø¨Øª Ø´Ùˆ â€” Ù‡Ù…Ù‡ Ø¯Ø± Ù„ÛŒØ³Øª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ø¯ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</div>
      <div style="margin-top:14px">
        <button id="modalContinue" class="confirm">Ø´Ø±ÙˆØ¹ Ú©Ù†</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ====== FIREBASE CONFIG: Ø§ÛŒÙ† Ù‚Ø³Ù…Øª Ø±Ø§ Ø¨Ø§ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù¾Ø±ÙˆÚ˜Ù‡Ù” Ø®ÙˆØ¯Øª Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù† ====== */
const FIREBASE_CONFIG = {
  apiKey: "PUT_YOUR_apiKey",
  authDomain: "PUT_YOUR_project.firebaseapp.com",
  databaseURL: "https://PUT_YOUR_project-default-rtdb.firebaseio.com",
  projectId: "PUT_YOUR_project",
  storageBucket: "PUT_YOUR_project.appspot.com",
  messagingSenderId: "PUT_YOUR_messagingSenderId",
  appId: "PUT_YOUR_appId"
};
/* ======================================================================== */

// simple sanity check
if (!FIREBASE_CONFIG || (FIREBASE_CONFIG.apiKey || '').startsWith('PUT_YOUR')) {
  setTimeout(()=>{ alert('âš ï¸ Ù„Ø·ÙØ§Ù‹ FIREBASE_CONFIG Ø±Ø§ Ø¯Ø± index.html Ù¾Ø± Ú©Ù†ÛŒØ¯ (Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§Ø² Firebase Console).'); }, 300);
}

firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();

const ROOM = 'main';
const participantsRef = db.ref(`rooms/${ROOM}/participants`);
const teamsRef = db.ref(`rooms/${ROOM}/teams`);
const settingsRef = db.ref(`rooms/${ROOM}/settings`);

// local client id
let CLIENT_ID = localStorage.getItem('ts_client_id_v3');
if (!CLIENT_ID) { CLIENT_ID = 'c_' + Math.random().toString(36).slice(2,10); localStorage.setItem('ts_client_id_v3', CLIENT_ID); }

// DOM
const welcomeModal = document.getElementById('welcomeModal');
const modalContinue = document.getElementById('modalContinue');
const familyInput = document.getElementById('familyInput');
const nextBtn = document.getElementById('nextBtn');
const roleArea = document.getElementById('roleArea');
const rolePlayer = document.getElementById('rolePlayer');
const roleGk = document.getElementById('roleGk');
const registerBtn = document.getElementById('registerBtn');
const participantsEl = document.getElementById('participants');
const teamsArea = document.getElementById('teamsArea');
const countSpan = document.getElementById('count');
const gkSpan = document.getElementById('gkcount');
const forceRecompute = document.getElementById('forceRecompute');

let selectedRole = 'player';

// modal controls
modalContinue.addEventListener('click', ()=> { welcomeModal.style.display = 'none'; familyInput.focus(); });

// next: validate english name
nextBtn.addEventListener('click', ()=> {
  const v = (familyInput.value||'').trim();
  if (!v) return alert('Ù„Ø·ÙØ§Ù‹ ÙØ§Ù…ÛŒÙ„ÛŒØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');
  if (!/^[A-Za-z\s'-]+$/.test(v)) return alert('ÙÙ‚Ø· Ø­Ø±ÙˆÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ (A-Z)ØŒ ÙØ§ØµÙ„Ù‡ØŒ \' Ùˆ - Ù…Ø¬Ø§Ø² Ø§Ø³Øª.');
  roleArea.style.display = 'block';
  rolePlayer.style.background='rgba(255,255,255,0.03)';
  roleGk.style.background='transparent';
  selectedRole = 'player';
});

// role select visuals
rolePlayer.addEventListener('click', ()=>{ selectedRole='player'; rolePlayer.style.background='rgba(255,255,255,0.03)'; roleGk.style.background='transparent'; });
roleGk.addEventListener('click', ()=>{ selectedRole='gk'; roleGk.style.background='rgba(255,255,255,0.03)'; rolePlayer.style.background='transparent'; });

// register button
registerBtn.addEventListener('click', async ()=>{
  const name = (familyInput.value||'').trim();
  if (!name) return alert('Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');
  // check if already registered on this client
  try {
    const existing = (await participantsRef.child(CLIENT_ID).once('value')).val();
    if (existing) { return alert('Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ (Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡).'); }
  } catch(err) {
    console.error('read existing error', err);
    return alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù‚Ø¨Ù„ÛŒ â€” Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„ Ø®Ø·Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†');
  }

  // write record
  const rec = { clientId: CLIENT_ID, name, role: selectedRole, ts: Date.now() };
  registerBtn.disabled = true;
  try {
    await participantsRef.child(CLIENT_ID).set(rec);
    showConfirmation(name, selectedRole);
    familyInput.value = '';
    roleArea.style.display = 'none';
    // teams recompute happens in participantsRef.on('value') listener
  } catch(err) {
    console.error('write error', err);
    alert('âŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯ â€” Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ FIREBASE_CONFIG Ù¾Ø± Ø´Ø¯Ù‡ Ùˆ Ù‚ÙˆØ§Ù†ÛŒÙ† Realtime DB Ø§Ø¬Ø§Ø²Ù‡Ù” Ù†ÙˆØ´ØªÙ† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.');
  } finally {
    registerBtn.disabled = false;
  }
});

// realtime listeners
participantsRef.on('value', snap => {
  const obj = snap.val() || {};
  renderParticipants(obj);
  // recompute teams on every change (keeps live)
  recomputeTeams().catch(e=>console.error('recompute error', e));
});
teamsRef.on('value', snap => renderTeams(snap.val()));

// render participants
function renderParticipants(obj){
  participantsEl.innerHTML = '';
  const list = Object.entries(obj||{}).map(([id,v]) => ({id, ...v}));
  list.sort((a,b) => (a.ts||0) - (b.ts||0));
  countSpan.textContent = list.length;
  gkSpan.textContent = list.filter(x=>x.role==='gk').length;
  if (list.length === 0) { participantsEl.innerHTML = '<div class="small">Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ú©Ø±Ø¯Ù‡</div>'; return; }
  for (const p of list){
    const d = document.createElement('div'); d.className='part';
    const left = document.createElement('div'); left.innerHTML = `<strong>${escapeHtml(p.name)}</strong>` + (p.clientId===CLIENT_ID ? ' <small>(Ø´Ù…Ø§)</small>' : '');
    const right = document.createElement('div'); right.innerHTML = `<span class="${p.role==='gk'?'role-keeper':'role-player'}">${p.role==='gk'?'ğŸ¥… Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†':'âš½ Ø¨Ø§Ø²ÛŒÚ©Ù†'}</span>`;
    d.appendChild(left); d.appendChild(right);
    participantsEl.appendChild(d);
  }
}

function renderTeams(obj){
  teamsArea.innerHTML = '';
  const team0 = (obj && obj.team0) || {members:[], subs:[]};
  const team1 = (obj && obj.team1) || {members:[], subs:[]};
  const title0 = `<div class="team-title"><span style="font-size:18px; color:var(--accent1)">ğŸ”µ</span> <div>ØªÛŒÙ… 1 â€” ${team0.members.length} Ù†ÙØ±</div></div>`;
  const title1 = `<div class="team-title"><span style="font-size:18px; color:var(--accent3)">ğŸŸ¢</span> <div>ØªÛŒÙ… 2 â€” ${team1.members.length} Ù†ÙØ±</div></div>`;
  const card0 = document.createElement('div'); card0.className='team-card'; card0.innerHTML = title0;
  if (team0.members.length === 0) card0.innerHTML += `<div style="margin-top:8px"><em>â€” Ø®Ø§Ù„ÛŒ</em></div>`;
  else {
    for (const m of team0.members) card0.innerHTML += `<div style="margin-top:6px">${m.role==='gk'?'ğŸ§¤':'âš½'} &nbsp; <strong>${escapeHtml(m.name)}</strong></div>`;
  }
  if (team0.subs && team0.subs.length) card0.innerHTML += `<div class="subs"><em>ğŸ”„ ØªØ¹ÙˆÛŒØ¶ÛŒâ€ŒÙ‡Ø§:</em> ${team0.subs.map(s=>escapeHtml(s.name)).join(' ØŒ ')}</div>`;
  teamsArea.appendChild(card0);

  const card1 = document.createElement('div'); card1.className='team-card'; card1.innerHTML = title1;
  if (team1.members.length === 0) card1.innerHTML += `<div style="margin-top:8px"><em>â€” Ø®Ø§Ù„ÛŒ</em></div>`;
  else {
    for (const m of team1.members) card1.innerHTML += `<div style="margin-top:6px">${m.role==='gk'?'ğŸ§¤':'âš½'} &nbsp; <strong>${escapeHtml(m.name)}</strong></div>`;
  }
  if (team1.subs && team1.subs.length) card1.innerHTML += `<div class="subs"><em>ğŸ”„ ØªØ¹ÙˆÛŒØ¶ÛŒâ€ŒÙ‡Ø§:</em> ${team1.subs.map(s=>escapeHtml(s.name)).join(' ØŒ ')}</div>`;
  teamsArea.appendChild(card1);
}

// escape
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// confirmation popup
function showConfirmation(name, role){
  const modal = document.createElement('div'); modal.className='modal';
  const card = document.createElement('div'); card.className='modal-card';
  card.innerHTML = `<div style="font-size:32px;margin-bottom:8px">âœ…</div><div style="font-weight:800">${escapeHtml(name)} â€” ${role==='gk'?'Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†':'Ø¨Ø§Ø²ÛŒÚ©Ù†'}</div><div class="small" style="margin-top:8px">Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯</div>`;
  modal.appendChild(card); document.body.appendChild(modal);
  setTimeout(()=> modal.remove(), 1600);
}

// recompute teams (core algorithm)
async function recomputeTeams(){
  try {
    const participants = (await participantsRef.once('value')).val() || {};
    const list = Object.values(participants);
    const teamsCount = 2;
    const gks = list.filter(x=>x.role==='gk');
    const players = list.filter(x=>x.role!=='gk');
    shuffleArray(gks); shuffleArray(players);
    const teams = Array.from({length:teamsCount}, ()=>({members:[], subs:[]}));
    // assign GK
    for (let i=0;i<teamsCount;i++){
      if (gks[i]) teams[i].members.push({id: gks[i].clientId, name: gks[i].name, role:'gk'});
    }
    // assign players round-robin while respecting max 5
    let idx = 0;
    for (const p of players) {
      let placed = false;
      for (let attempt=0; attempt<teamsCount; attempt++){
        const tIdx = (idx + attempt) % teamsCount;
        if (teams[tIdx].members.length < 5) {
          teams[tIdx].members.push({id: p.clientId, name: p.name, role:'player'});
          placed = true; idx = tIdx + 1; break;
        }
      }
      if (!placed) {
        // push to smallest subs
        let minSubs = Infinity, pick = 0;
        for (let j=0;j<teamsCount;j++){
          if (teams[j].subs.length < minSubs){ minSubs = teams[j].subs.length; pick = j; }
        }
        teams[pick].subs.push({id: p.clientId, name: p.name, role:'player'});
      }
      idx++;
    }
    // small balancing attempt (rare)
    const out = { team0: teams[0], team1: teams[1] };
    await teamsRef.set(out);
    await settingsRef.update({ teamsCount, lastUpdated: Date.now() });
  } catch(err) {
    console.error('recomputeTeams err', err);
  }
}

forceRecompute.addEventListener('click', ()=> { recomputeTeams().catch(e=>console.error(e)); });

// initial defaults
(async ()=>{
  try {
    const s = (await settingsRef.once('value')).val();
    if (!s) await settingsRef.set({ teamsCount: 2, signupOpen: true, assigned: false });
  } catch(e) { console.error('init settings err', e); }
})();

</script>
</body>
</html>
