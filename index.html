<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Shuffle â€” Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (Ø¯Ùˆ ØªÛŒÙ…)</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#06102b; --bg2:#001024; --accent:#00b0ff; --accent2:#ffd600; --accent3:#1db954;
  --card: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Vazirmatn',Tahoma,Arial;direction:rtl;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff}
.container{max-width:1100px;margin:18px auto;padding:14px;display:grid;grid-template-columns:1fr 360px;gap:18px}
.header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center}
.title{font-weight:800;color:var(--accent);font-size:20px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
.form-row{display:flex;gap:8px;align-items:center;margin-top:12px}
.input,select,button{padding:10px;border-radius:10px;border:0;background:rgba(255,255,255,0.03);color:#fff;font-size:15px}
.big{background:linear-gradient(90deg,var(--accent),#0066cc);border:none;padding:12px 14px;font-weight:700;cursor:pointer;color:#001}
.big:disabled{opacity:0.6}
.small{font-size:13px;color:rgba(255,255,255,0.75)}
.live-list{max-height:360px;overflow:auto;margin-top:12px}
.part{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;margin-bottom:10px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(0,0,0,0.12))}
.role-keeper{color:var(--accent2);font-weight:700}
.role-player{color:var(--accent3);font-weight:700}
.teams{margin-top:16px}
.team-card{background:rgba(0,0,0,0.2);padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03)}
.status{margin-top:12px;padding:10px;border-radius:10px;background:rgba(0,0,0,0.2);font-size:14px;color:#fff}
.hidden{display:none}
.modal{position:fixed;left:0;top:0;right:0;bottom:0;background:linear-gradient(rgba(0,0,0,0.65),rgba(0,0,0,0.65));display:flex;align-items:center;justify-content:center;z-index:9999}
.modal-card{background:linear-gradient(180deg,#031028,#04112b);border-radius:16px;padding:22px;width:420px;text-align:center}
.ball{font-size:80px;animation:floaty 1.6s ease-in-out infinite, rotate 2.4s linear infinite;text-shadow:0 6px 20px rgba(0,0,0,0.6)}
@keyframes floaty {0%{transform:translateY(0)}50%{transform:translateY(-10px)}100%{transform:translateY(0)}}
@keyframes rotate {from{transform:rotate(0)}to{transform:rotate(360deg)}}
.bad{color:#ff6b6b}
.good{color:#6bf07a}
.footer{grid-column:1/-1;text-align:center;margin-top:8px;color:rgba(255,255,255,0.45);font-size:13px}
@media(max-width:980px){.container{grid-template-columns:1fr;padding:10px}}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="title">âš½ Team Shuffle â€” Ø¯Ùˆ ØªÛŒÙ… (Ø´Ø§Ù†Ø³ÛŒ)</div>
        <div class="small">Ù‡Ø± Ø¨Ø§Ø²Ø¯ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ ÙÙ‚Ø· ÛŒÚ©â€ŒØ¨Ø§Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†Ø¯ (Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡ / Ù…Ø±ÙˆØ±Ú¯Ø±)</div>
      </div>
      <div class="small">ØªÛŒÙ…â€ŒÙ‡Ø§: Û² â€” Ù‡Ø± ØªÛŒÙ… Ø­Ø¯Ø§Ú©Ø«Ø± Ûµ Ù†ÙØ± (Ø´Ø§Ù…Ù„ GK)</div>
    </div>

    <!-- LEFT -->
    <section class="card">
      <h3 style="margin:0">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø³Ø±ÛŒØ¹</h3>
      <div class="small" style="margin-top:6px">ÙØ§Ù…ÛŒÙ„ÛŒØª Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ØŒ Ù†Ù‚Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† Ùˆ Ø«Ø¨Øª Ø¨Ø²Ù†.</div>

      <div class="form-row" style="margin-top:12px;">
        <input id="familyInput" class="input" placeholder="Ù…Ø«Ø§Ù„: Amiri" style="flex:1" autocomplete="off"/>
        <button id="nextBtn" class="big" style="width:120px">Ø¨Ø¹Ø¯ÛŒ â–¶</button>
      </div>

      <div id="roleArea" class="hidden" style="margin-top:12px">
        <div class="small">Ù†Ù‚Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="rolePlayer" class="input" style="flex:1">ğŸ‘Ÿ Ø¨Ø§Ø²ÛŒÚ©Ù†</button>
          <button id="roleGk" class="input" style="flex:1">ğŸ¥… Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†</button>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="registerBtn" class="big" style="flex:1">âœ… Ø«Ø¨Øª Ùˆ Ù¾ÛŒÙˆØ³ØªÙ†</button>
        </div>
      </div>

      <div id="statusBox" class="status" style="margin-top:12px">ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù…Ø§Ø¯Ù‡</div>

      <div style="margin-top:16px;font-weight:700">Ù„ÛŒØ³Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (Ø²Ù†Ø¯Ù‡)</div>
      <div id="participants" class="live-list"></div>

      <div class="teams" id="teamsArea"></div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <h3 style="margin:0">Ø¢Ù…Ø§Ø± Ùˆ Ú©Ù†ØªØ±Ù„</h3>
      <div class="small" style="margin-top:8px">Ø¯Ùˆ ØªÛŒÙ… â€” Ù‡Ø± ØªÛŒÙ… ØªØ§ Ûµ Ù†ÙØ± (Ø´Ø§Ù…Ù„ GK). Ø¨Ù‚ÛŒÙ‡ ØªØ¹ÙˆÛŒØ¶ÛŒ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯.</div>
      <div style="margin-top:12px;font-weight:700">Ø¢Ù…Ø§Ø±</div>
      <div class="small" style="margin-top:8px">Ú©Ù„ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡: <span id="count">0</span></div>
      <div class="small" style="margin-top:6px">Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†â€ŒÙ‡Ø§: <span id="gkcount">0</span></div>
      <div style="margin-top:12px">
        <button id="forceRecompute" class="input" style="width:100%">â™»ï¸ Ø¨Ø§Ø²Ú†ÛŒÙ†Ø´ Ø¯Ø³ØªÛŒ</button>
      </div>
      <div style="margin-top:12px">
        <button id="clearLocal" class="input" style="width:100%">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù…Ø­Ù„ÛŒ (Ø¨Ø±Ø§ÛŒ ØªØ³Øª)</button>
      </div>
      <div style="margin-top:14px;font-size:13px;color:rgba(255,255,255,0.6)">Ø§Ú¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø§Ù†Ø¬Ø§Ù… Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯: Ù¾ÛŒØ§Ù…ÛŒ Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† Ù…ÛŒâ€ŒØ¢ÛŒØ¯ Ú©Ù‡ Ø¯Ù„ÛŒÙ„ Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÙˆÛŒØ¯ (ØªØ§ÛŒÛŒØ¯ Ú©Ù† config & rules).</div>
    </aside>

    <div class="footer">Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø§ Firebase Realtime Database Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ â€” Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø§ÙˆÙ„ÛŒÙ‡ Ù„Ø·ÙØ§Ù‹ Ù‚ÙˆØ§Ø¹Ø¯ DB Ø±Ø§ Ø¨Ø§Ø² Ø¨Ø°Ø§Ø±</div>
  </div>

  <!-- welcome modal -->
  <div id="welcomeModal" class="modal">
    <div class="modal-card">
      <div style="margin-bottom:8px" class="ball">âš½</div>
      <h2 style="margin:6px 0 0 0">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒ!</h2>
      <div class="small" style="margin-top:8px">Ù†Ø§Ù…Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ØŒ Ù†Ù‚Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† Ùˆ Ø«Ø¨Øª Ø´Ùˆ â€” Ù‡Ù…Ù‡ Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ Ù…ÛŒâ€ŒØ¨ÛŒÙ†Ù†Ø¯.</div>
      <div style="margin-top:14px">
        <button id="modalContinue" class="big">Ø´Ø±ÙˆØ¹ Ú©Ù†</button>
      </div>
    </div>
  </div>

  <!-- Firebase (compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ====== Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù† Ø¨Ø§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡Ù” Firebase Ø®ÙˆØ¯Øª ======
  Ø§Ø² Firebase Console -> Project settings -> SDK setup and config Ø¨Ø±Ø¯Ø§Ø´Øª Ú©Ù†
================================================================= */
const FIREBASE_CONFIG = {
  apiKey: "PUT_YOUR_apiKey",
  authDomain: "PUT_YOUR_project.firebaseapp.com",
  databaseURL: "https://PUT_YOUR_project-default-rtdb.firebaseio.com",
  projectId: "PUT_YOUR_project",
  storageBucket: "PUT_YOUR_project.appspot.com",
  messagingSenderId: "PUT_YOUR_messagingSenderId",
  appId: "PUT_YOUR_appId"
};
/* ================================================================= */

const missingConfig = !FIREBASE_CONFIG || (FIREBASE_CONFIG.apiKey||'').startsWith('PUT_YOUR');
if(missingConfig){
  console.warn('FIREBASE_CONFIG not filled. Replace config in the HTML before use.');
}

firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();

// room name
const ROOM = 'main';

// refs
const participantsRef = db.ref(`rooms/${ROOM}/participants`);
const teamsRef = db.ref(`rooms/${ROOM}/teams`);
const settingsRef = db.ref(`rooms/${ROOM}/settings`);

// client id (saved in localStorage) -> prevents multiple registrations from same browser/device
let CLIENT_ID = localStorage.getItem('ts_client_id_v4');
if (!CLIENT_ID) {
  CLIENT_ID = 'c_' + Math.random().toString(36).slice(2,10);
  localStorage.setItem('ts_client_id_v4', CLIENT_ID);
}

// DOM
const welcomeModal = document.getElementById('welcomeModal');
const modalContinue = document.getElementById('modalContinue');
const familyInput = document.getElementById('familyInput');
const nextBtn = document.getElementById('nextBtn');
const roleArea = document.getElementById('roleArea');
const rolePlayer = document.getElementById('rolePlayer');
const roleGk = document.getElementById('roleGk');
const registerBtn = document.getElementById('registerBtn');
const participantsEl = document.getElementById('participants');
const teamsArea = document.getElementById('teamsArea');
const statusBox = document.getElementById('statusBox');
const countSpan = document.getElementById('count');
const gkSpan = document.getElementById('gkcount');
const forceRecompute = document.getElementById('forceRecompute');
const clearLocal = document.getElementById('clearLocal');

let selectedRole = 'player';

// welcome
modalContinue.addEventListener('click', ()=> {
  welcomeModal.style.display = 'none';
  familyInput.focus();
});

// next
nextBtn.addEventListener('click', ()=>{
  const v = (familyInput.value||'').trim();
  if(!v) return alert('Ù„Ø·ÙØ§Ù‹ ÙØ§Ù…ÛŒÙ„ÛŒØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');
  if(!/^[A-Za-z\s'-]+$/.test(v)) return alert('ÙÙ‚Ø· Ø­Ø±ÙˆÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ (A-Z)ØŒ ÙØ§ØµÙ„Ù‡ØŒ \' Ùˆ - Ù…Ø¬Ø§Ø² Ø§Ø³Øª.');
  roleArea.classList.remove('hidden');
  selectedRole='player';
  rolePlayer.style.background='rgba(255,255,255,0.03)';
  roleGk.style.background='transparent';
});

// role selection visuals
rolePlayer.addEventListener('click', ()=>{ selectedRole='player'; rolePlayer.style.background='rgba(255,255,255,0.03)'; roleGk.style.background='transparent'; });
roleGk.addEventListener('click', ()=>{ selectedRole='gk'; roleGk.style.background='rgba(255,255,255,0.03)'; rolePlayer.style.background='transparent'; });

// helper shuffle
function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

// optimistic UI + robust write
registerBtn.addEventListener('click', async ()=>{
  const name = (familyInput.value||'').trim();
  if(!name) return alert('Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');
  // client-side check: have we already registered on this browser?
  try {
    const snap = await participantsRef.child(CLIENT_ID).once('value');
    if(snap.exists()){
      return updateStatus('Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ (Ù‡Ù…Ø§Ù† Ø¯Ø³ØªÚ¯Ø§Ù‡).', 'bad');
    }
  } catch(err){
    console.error('check existing error', err);
    updateStatus('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù‚Ø¨Ù„ÛŒ. Ø§ØªØµØ§Ù„ ÛŒØ§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Firebase Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†.', 'bad');
    return;
  }

  // prepare record
  const rec = { clientId: CLIENT_ID, name, role: selectedRole, ts: Date.now() };

  registerBtn.disabled = true;
  updateStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª...', ''); 

  // write with explicit key = CLIENT_ID so duplicate per client prevented
  try {
    await participantsRef.child(CLIENT_ID).set(rec);
    updateStatus('âœ… Ø«Ø¨Øª Ø´Ø¯ â€” Ù…Ù†ØªØ¸Ø± Ù„ÛŒØ³Øª Ø²Ù†Ø¯Ù‡ Ø¨Ø§Ø´ÛŒØ¯', 'good');
    // clear input & hide role to avoid double clicks
    familyInput.value = '';
    roleArea.classList.add('hidden');
  } catch(err){
    console.error('write error', err);
    // permission denied or network error
    if (err && err.code === 'PERMISSION_DENIED') {
      updateStatus('âŒ Ø®Ø·Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ: Ù‚ÙˆØ§Ø¹Ø¯ Realtime DB Ù†ÙˆØ´ØªÙ† Ø±Ø§ Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù‡â€ŒØ§Ù†Ø¯. (Rules) â€” Ø¨Ø±Ø§ÛŒ ØªØ³Øª rules Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†.', 'bad');
    } else {
      updateStatus('âŒ Ø«Ø¨Øª Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯ â€” Ø§ØªØµØ§Ù„ ÛŒØ§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Firebase Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†. (Ø¨Ù‡ Ú©Ù†Ø³ÙˆÙ„ Ù†Ú¯Ø§Ù‡ Ú©Ù†)', 'bad');
    }
  } finally {
    registerBtn.disabled = false;
  }
});

// render participants list live
participantsRef.on('value', snap => {
  const obj = snap.val() || {};
  renderParticipants(obj);
  // recompute teams whenever participants change
  recomputeTeams().catch(e=>console.error('recomputeTeams err', e));
});

// render teams (data stored by recomputeTeams)
teamsRef.on('value', snap => {
  renderTeams(snap.val() || {});
});

function renderParticipants(obj){
  participantsEl.innerHTML = '';
  const list = Object.values(obj || {});
  list.sort((a,b)=> (a.ts||0) - (b.ts||0));
  countSpan.textContent = list.length;
  gkSpan.textContent = list.filter(x=>x.role==='gk').length;
  if(list.length === 0){
    participantsEl.innerHTML = '<div class="small">Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ú©Ø±Ø¯Ù‡</div>';
    return;
  }
  for(const p of list){
    const d = document.createElement('div'); d.className='part';
    const left = document.createElement('div');
    left.innerHTML = `<strong>${escapeHtml(p.name)}</strong> ${p.clientId===CLIENT_ID?'<small> (Ø´Ù…Ø§)</small>':''}`;
    const right = document.createElement('div');
    right.innerHTML = `<span class="${p.role==='gk'?'role-keeper':'role-player'}">${p.role==='gk'?'ğŸ¥… Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†':'âš½ Ø¨Ø§Ø²ÛŒÚ©Ù†'}</span>`;
    d.appendChild(left); d.appendChild(right);
    participantsEl.appendChild(d);
  }
}

function renderTeams(obj){
  teamsArea.innerHTML = '';
  const t0 = obj.team0 || {members:[], subs:[]};
  const t1 = obj.team1 || {members:[], subs:[]};
  const card0 = document.createElement('div'); card0.className='team-card';
  card0.innerHTML = `<div style="font-weight:800">ğŸ”µ ØªÛŒÙ… 1 â€” ${t0.members.length} Ù†ÙØ±</div>`;
  if(t0.members.length===0) card0.innerHTML += `<div style="margin-top:8px"><em>â€” Ø®Ø§Ù„ÛŒ</em></div>`;
  else for(const m of t0.members) card0.innerHTML += `<div style="margin-top:6px">${m.role==='gk'?'ğŸ§¤':'âš½'} &nbsp;<strong>${escapeHtml(m.name)}</strong></div>`;
  if(t0.subs && t0.subs.length) card0.innerHTML += `<div class="small" style="margin-top:8px">ğŸ”„ ØªØ¹ÙˆÛŒØ¶ÛŒâ€ŒÙ‡Ø§: ${t0.subs.map(s=>escapeHtml(s.name)).join(' , ')}</div>`;
  teamsArea.appendChild(card0);

  const card1 = document.createElement('div'); card1.className='team-card';
  card1.innerHTML = `<div style="font-weight:800">ğŸŸ¢ ØªÛŒÙ… 2 â€” ${t1.members.length} Ù†ÙØ±</div>`;
  if(t1.members.length===0) card1.innerHTML += `<div style="margin-top:8px"><em>â€” Ø®Ø§Ù„ÛŒ</em></div>`;
  else for(const m of t1.members) card1.innerHTML += `<div style="margin-top:6px">${m.role==='gk'?'ğŸ§¤':'âš½'} &nbsp;<strong>${escapeHtml(m.name)}</strong></div>`;
  if(t1.subs && t1.subs.length) card1.innerHTML += `<div class="small" style="margin-top:8px">ğŸ”„ ØªØ¹ÙˆÛŒØ¶ÛŒâ€ŒÙ‡Ø§: ${t1.subs.map(s=>escapeHtml(s.name)).join(' , ')}</div>`;
  teamsArea.appendChild(card1);
}

// core algorithm: assign 2 teams, one GK per team, max 5 per team (including GK), rest -> subs, balance difference <=1
async function recomputeTeams(){
  try {
    const participantsSnap = await participantsRef.once('value');
    const participants = participantsSnap.val() || {};
    const list = Object.values(participants);
    const gks = list.filter(x=>x.role==='gk');
    const players = list.filter(x=>x.role!=='gk');
    shuffleArray(gks); shuffleArray(players);
    const teamsCount = 2;
    const teams = Array.from({length:teamsCount}, ()=>({members:[], subs:[]}));

    // assign GK (if available)
    for(let i=0;i<teamsCount;i++){
      if(gks[i]) teams[i].members.push({id:gks[i].clientId, name:gks[i].name, role:'gk'});
    }

    // Assign players round-robin with max 5 constraint
    let idx = 0;
    for(const p of players){
      // try to place in a team with size <5 and minimal current size
      const sizes = teams.map(t=>t.members.length);
      const minSize = Math.min(...sizes);
      const candidates = [];
      for(let i=0;i<teamsCount;i++){
        if(teams[i].members.length === minSize && teams[i].members.length < 5) candidates.push(i);
      }
      if(candidates.length>0){
        const pick = candidates[Math.floor(Math.random()*candidates.length)];
        teams[pick].members.push({id:p.clientId, name:p.name, role:'player'});
      } else {
        // all teams full or no candidate -> push to smallest subs
        let minSubs = Infinity, chosen = 0;
        for(let i=0;i<teamsCount;i++){
          if(teams[i].subs.length < minSubs){ minSubs = teams[i].subs.length; chosen = i; }
        }
        teams[chosen].subs.push({id:p.clientId, name:p.name, role:'player'});
      }
      idx++;
    }

    // balancing: if team sizes differ by more than 1 and there are subs, try move
    const sizes = teams.map(t=>t.members.length);
    while(Math.abs(sizes[0]-sizes[1])>1){
      const from = sizes[0]>sizes[1]?0:1;
      const to = from===0?1:0;
      // move last non-gk from 'from' to 'to' if exists
      const mvIndex = teams[from].members.findIndex(m=>m.role!=='gk');
      if(mvIndex>=0){
        const mv = teams[from].members.splice(mvIndex,1)[0];
        teams[to].members.push(mv);
        sizes[0]=teams[0].members.length; sizes[1]=teams[1].members.length;
      } else break;
    }

    // push result to DB
    await teamsRef.set({ team0: teams[0], team1: teams[1], updated: Date.now() });
    updateStatus('ØªÛŒÙ…â€ŒÙ‡Ø§ Ø¢Ù¾Ø¯ÛŒØª Ø´Ø¯', 'good');
  } catch(err){
    console.error('recomputeTeams error', err);
    updateStatus('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªÛŒÙ…â€ŒÙ‡Ø§ â€” Ø¨Ù‡ Ú©Ù†Ø³ÙˆÙ„ Ù†Ú¯Ø§Ù‡ Ú©Ù†', 'bad');
  }
}

// helper update status (text + class)
function updateStatus(text, kind){
  statusBox.textContent = 'ÙˆØ¶Ø¹ÛŒØª: ' + text;
  statusBox.classList.remove('bad','good');
  if(kind==='bad') statusBox.classList.add('bad');
  if(kind==='good') statusBox.classList.add('good');
}

// clear local for testing
clearLocal.addEventListener('click', ()=> {
  localStorage.removeItem('ts_client_id_v4');
  alert('Ø´Ù†Ø§Ø³Ù‡ Ù…Ø­Ù„ÛŒ Ù¾Ø§Ú© Ø´Ø¯. ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù† Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù† (Ø¨Ø±Ø§ÛŒ ØªØ³Øª).');
});

// force recompute
forceRecompute.addEventListener('click', ()=> {
  recomputeTeams().catch(e=>console.error(e));
});

// escape
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// initial set status
updateStatus(missingConfig ? 'FIREBASE_CONFIG Ù¾Ø± Ù†Ø´Ø¯Ù‡ â€” Ù…Ù‚Ø¯Ø§Ø±Ù‡Ø§ Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†' : 'Ø¢Ù…Ø§Ø¯Ù‡', missingConfig ? 'bad' : '');

</script>
</body>
</html>
