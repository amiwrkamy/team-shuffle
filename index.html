<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Shuffle â€” ØªÛŒÙ…â€ŒÚ©Ø´ÛŒ Ø´Ø§Ù†Ø³ÛŒ</title>
<!-- Google font (optional) -->
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --accent:#1db954;
    --bg-overlay: rgba(0,0,0,0.55);
    --card-bg: rgba(255,255,255,0.06);
    color-scheme: dark;
  }
  html,body{height:100%;margin:0;font-family:'Vazirmatn',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{
    background: linear-gradient(var(--bg-overlay),var(--bg-overlay)), url('bg.jpg') center/cover no-repeat fixed;
    display:flex;align-items:flex-start;justify-content:center;padding:32px 12px;
    color:#fff;
  }
  .container{max-width:1100px;width:100%;display:grid;grid-template-columns: 1fr 420px; gap:20px; align-items:start;}
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  h1{margin:0;font-size:20px;display:flex;align-items:center;gap:10px}
  .card{background:var(--card-bg);border-radius:12px;padding:16px;box-shadow:0 6px 22px rgba(0,0,0,0.5);}
  .left{min-height:420px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button, select, input[type="text"]{
    background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 10px;border-radius:8px;
  }
  .big-btn{padding:12px 14px;font-weight:600;background:linear-gradient(90deg,var(--accent),#29a06a);border:none}
  .muted{color:rgba(255,255,255,0.7);font-size:13px}
  .form-row{display:flex;gap:8px;margin-top:10px;align-items:center}
  .live-list{max-height:440px;overflow:auto;margin-top:12px}
  .participant{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);}
  .role-player{color:#fff}
  .role-gk{color:#ffd166}
  .teams{margin-top:12px}
  .team-card{background:rgba(0,0,0,0.25);padding:10px;border-radius:8px;margin-bottom:8px}
  .subs{font-size:13px;color:#ddd;margin-top:6px}
  .admin-panel{display:flex;flex-direction:column;gap:8px}
  .note{font-size:13px;color:#eee;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:8px;border-radius:8px}
  footer{grid-column:1/-1;text-align:center;margin-top:12px;color:rgba(255,255,255,0.6);font-size:13px}
  .badge{background:rgba(0,0,0,0.35);padding:6px 8px;border-radius:999px;font-weight:600}
  /* responsive */
  @media(max-width:980px){
    .container{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>âš½ Team Shuffle â€” Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ ØªÛŒÙ…ÛŒ</h1>
      <div class="badge">Ù„Ø§ÛŒÙˆ â€” Ø¨Ø¯ÙˆÙ† ÙˆØ±ÙˆØ¯</div>
    </header>

    <!-- LEFT: Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª -->
    <section class="card left">
      <h2 style="margin:0 0 8px 0">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (Ù‡Ù…Ù‡ Ø¨Ø¨ÛŒÙ†Ù†Ø¯)</h2>
      <div class="muted">Ø§Ø³Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù† Ùˆ Ù†Ù‚Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† â€” Ù‡Ø± Ù†ÙØ± ÙÙ‚Ø· ÛŒÚ©â€ŒØ¨Ø§Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†Ø¯.</div>

      <div class="form-row">
        <input id="nameInput" type="text" placeholder="Ù†Ø§Ù… (Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒ)" style="flex:1" />
        <select id="roleSelect">
          <option value="player">âš½ Ø¨Ø§Ø²ÛŒÚ©Ù†</option>
          <option value="gk">ğŸ¥… Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†</option>
        </select>
        <button id="joinBtn" class="big-btn">Ø«Ø¨Øª Ù†Ø§Ù…</button>
      </div>

      <div style="margin-top:10px" class="muted">ÙˆØ¶Ø¹ÛŒØª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: <span id="signupStatus">Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span></div>

      <div class="live-list" id="participantsList" aria-live="polite" style="margin-top:12px">
        <!-- participants will appear here -->
      </div>

      <div class="teams card" id="teamsArea">
        <!-- assigned teams -->
      </div>
    </section>

    <!-- RIGHT: Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
    <aside class="card">
      <h3 style="margin:0 0 6px 0">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª (Ø§Ø¯Ù…ÛŒÙ†)</h3>
      <div class="muted">Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø¯Ù…ÛŒÙ†ØŒ Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†.</div>

      <div class="admin-panel" style="margin-top:10px">
        <input id="adminPass" type="text" placeholder="Ø±Ù…Ø² Ø§Ø¯Ù…ÛŒÙ†" />
        <div style="display:flex;gap:8px">
          <select id="teamCountSelect">
            <option value="2">2ï¸âƒ£  2 ØªÛŒÙ…</option>
            <option value="3">3ï¸âƒ£  3 ØªÛŒÙ…</option>
            <option value="4">4ï¸âƒ£  4 ØªÛŒÙ…</option>
          </select>
          <button id="setTeamsBtn">ØªÙ†Ø¸ÛŒÙ… ØªØ¹Ø¯Ø§Ø¯ ØªÛŒÙ…</button>
        </div>

        <div style="display:flex;gap:8px">
          <button id="openSignupBtn">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
          <button id="closeSignupBtn">Ø¨Ø³ØªÙ† Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
        </div>

        <div style="display:flex;gap:8px">
          <button id="assignBtn" class="big-btn">ğŸ² Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ Ùˆ ØªÙ‚Ø³ÛŒÙ… ØªÛŒÙ…â€ŒÙ‡Ø§</button>
        </div>

        <div class="note" style="margin-top:8px">
          <div><strong>Ù‚ÙˆØ§Ù†ÛŒÙ†:</strong></div>
          <ul style="margin:6px 0 0 18px">
            <li>Ù‡Ø± ØªÛŒÙ… Ø¨Ø§ÛŒØ¯ ÛŒÚ© Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù† Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ (ØªØ¹Ø¯Ø§Ø¯ GK >= ØªØ¹Ø¯Ø§Ø¯ ØªÛŒÙ…).</li>
            <li>Ø­Ø¯Ø§Ú©Ø«Ø± Ø§Ø¹Ø¶Ø§ÛŒ Ù‡Ø± ØªÛŒÙ…: Ûµ Ù†ÙØ± (Ø´Ø§Ù…Ù„ GK). Ù…Ø§Ø²Ø§Ø¯ â†’ ØªØ¹ÙˆÛŒØ¶ÛŒ.</li>
            <li>Ø§Ø®ØªÙ„Ø§Ù Ø¨ÛŒÙ† ØªÛŒÙ…â€ŒÙ‡Ø§ Ø­Ø¯Ø§Ú©Ø«Ø± Û± Ù†ÙØ± Ø§Ø³Øª.</li>
            <li>Ú¯Ø²ÛŒÙ†Ù‡Ù” <em>Ø´Ø§Ù†Ø³ Ø¯ÙˆØ¨Ø§Ø±Ù‡</em> Ø­Ø°Ù Ø´Ø¯Ù‡ Ø§Ø³Øª.</li>
          </ul>
        </div>

        <div style="margin-top:8px" class="muted">ØªØ¹Ø¯Ø§Ø¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…â€ŒÙ‡Ø§: <span id="countSpan">0</span></div>
      </div>
    </aside>

    <footer>Ø·Ø±Ø§Ø­ÛŒ Ùˆ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ â€” Team Shuffle â€¢ Ø§Ø³ØªÙØ§Ø¯Ù‡Ù” Ø¢Ø²Ù…Ø§ÛŒØ´ÛŒ Ø¨Ø§ Firebase Realtime DB</footer>
  </div>

  <!-- Firebase (compat simple include) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* =========== CONFIG (Ù¾ÙØ± Ú©Ù†ÛŒØ¯) =========== */
/* Ø§Ø² Firebase Ú©Ù†Ø³ÙˆÙ„ØŒ config Ø±Ø§ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†ÛŒØ¯ */
const FIREBASE_CONFIG = {
  apiKey: "PUT_YOUR_apiKey_HERE",
  authDomain: "PUT_YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://PUT_YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId: "PUT_YOUR_PROJECT",
  storageBucket: "PUT_YOUR_PROJECT.appspot.com",
  messagingSenderId: "PUT_YOUR_messagingSenderId",
  appId: "PUT_YOUR_appId"
};
// Ø¢Ø¯Ø±Ø³ ØªØµÙˆÛŒØ± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ (Ø¯Ø± ØµÙˆØ±Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² URL Ø®Ø§Ø±Ø¬ÛŒ)
// Ø§Ú¯Ø± ÙØ§ÛŒÙ„ bg.jpg Ú©Ù†Ø§Ø± index.html Ø§Ø³Øª Ø¢Ù† Ø±Ø§ ØªØºÛŒÛŒØ± Ù†Ø¯Ù‡.
const BG_URL = null; // ÛŒØ§ 'https://.../your-image.jpg'

// Ø±Ù…Ø² Ø³Ø§Ø¯Ù‡Ù” Ø§Ø¯Ù…ÛŒÙ† (Ø¨Ø±Ø§ÛŒ ØªØ³Øª) â€” Ø­ØªÙ…Ø§Ù‹ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ ÙˆØ§Ù‚Ø¹ÛŒ Ø¢Ù† Ø±Ø§ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡
const ADMIN_PASS = "admin12345";
/* ========================================= */

if (BG_URL) {
  document.body.style.background = `linear-gradient(rgba(0,0,0,0.55),rgba(0,0,0,0.55)), url('${BG_URL}') center/cover no-repeat fixed`;
}

// init firebase
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();

// helper uid
function generateUID() {
  const s = crypto && crypto.getRandomValues ? crypto.getRandomValues(new Uint32Array(3)).join('-') : Math.random().toString(36).slice(2);
  return 'u_' + Date.now().toString(36) + '_' + s;
}
function getLocalUID() {
  let id = localStorage.getItem('ts_uid');
  if (!id) { id = generateUID(); localStorage.setItem('ts_uid', id); }
  return id;
}
const LOCAL_UID = getLocalUID();

// DOM
const nameInput = document.getElementById('nameInput');
const roleSelect = document.getElementById('roleSelect');
const joinBtn = document.getElementById('joinBtn');
const participantsList = document.getElementById('participantsList');
const signupStatus = document.getElementById('signupStatus');
const countSpan = document.getElementById('countSpan');
const adminPassInput = document.getElementById('adminPass');
const teamCountSelect = document.getElementById('teamCountSelect');
const setTeamsBtn = document.getElementById('setTeamsBtn');
const openSignupBtn = document.getElementById('openSignupBtn');
const closeSignupBtn = document.getElementById('closeSignupBtn');
const assignBtn = document.getElementById('assignBtn');
const teamsArea = document.getElementById('teamsArea');

// DB refs
const ROOM = 'main';
const roomRef = db.ref('rooms/' + ROOM);
const participantsRef = db.ref('rooms/' + ROOM + '/participants');
const settingsRef = db.ref('rooms/' + ROOM + '/settings');
const teamsRef = db.ref('rooms/' + ROOM + '/teams');

// utility
function showToast(msg) {
  alert(msg); // simple for now
}
function shuffleArray(a){
  for (let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// read settings and participants (live)
let latestSettings = {};
settingsRef.on('value', snap => {
  latestSettings = snap.val() || {};
  if (latestSettings.signupOpen) signupStatus.textContent = 'Ø¨Ø§Ø² â€” Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯';
  else signupStatus.textContent = 'Ø¨Ø³ØªÙ‡ â€” Ù…Ù†ØªØ¸Ø± Ø§Ø¯Ù…ÛŒÙ†';
  // show teamsCount if available (visual)
  if (latestSettings.teamsCount) {
    teamCountSelect.value = latestSettings.teamsCount;
  }
});
participantsRef.on('value', snap => {
  const data = snap.val() || {};
  renderParticipants(data);
});

// teams listener (after assign)
teamsRef.on('value', snap => {
  const t = snap.val();
  renderTeams(t);
});

// render participants
function renderParticipants(data) {
  participantsList.innerHTML = '';
  const arr = Object.entries(data || {}).map(([id,info]) => ({ id, ...info }));
  arr.sort((a,b)=> (a.ts||0) - (b.ts||0));
  countSpan.textContent = arr.length;
  if (arr.length === 0) {
    participantsList.innerHTML = '<div class="muted">Ù‡Ù†ÙˆØ² Ú©Ø³ÛŒ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª.</div>';
    return;
  }
  for (const p of arr) {
    const d = document.createElement('div');
    d.className = 'participant';
    const left = document.createElement('div');
    const roleSpan = document.createElement('span');
    roleSpan.textContent = p.role === 'gk' ? 'ğŸ¥…' : 'âš½';
    roleSpan.style.marginRight = '8px';
    left.appendChild(roleSpan);
    const name = document.createElement('strong');
    name.textContent = p.name || 'Ø¨ÛŒâ€ŒÙ†Ø§Ù…';
    left.appendChild(name);
    const right = document.createElement('div');
    right.innerHTML = `<span class="${p.role==='gk'?'role-gk':'role-player'}">${p.role==='gk'?'Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†':'Ø¨Ø§Ø²ÛŒÚ©Ù†'}</span>`;
    d.appendChild(left);
    d.appendChild(right);
    participantsList.appendChild(d);
  }
}

// render teams
function renderTeams(obj) {
  teamsArea.innerHTML = '';
  if (!obj) return;
  const keys = Object.keys(obj).filter(k=>k.startsWith('team'));
  if (!keys.length) return;
  const header = document.createElement('h3'); header.textContent = 'Ù†ØªÛŒØ¬Ù‡Ù” ØªÛŒÙ…â€ŒØ¨Ù†Ø¯ÛŒ'; teamsArea.appendChild(header);
  for (const k of keys.sort()) {
    const t = obj[k];
    const card = document.createElement('div'); card.className = 'team-card';
    const title = document.createElement('div'); title.innerHTML = `<strong>ØªÛŒÙ… ${ (parseInt(k.replace('team',''))+1) } â€” ${ (t.members ? t.members.length : 0) } Ù†ÙØ±</strong>`;
    card.appendChild(title);
    if (t.members && t.members.length) {
      for (const m of t.members) {
        const row = document.createElement('div'); row.style.marginTop='6px';
        row.innerHTML = `${m.role==='gk' ? 'ğŸ§¤' : 'âš½'} &nbsp; <strong>${m.name}</strong> ${m.id?'<small style="opacity:0.7">':' '}`;
        card.appendChild(row);
      }
    }
    if (t.subs && t.subs.length) {
      const subs = document.createElement('div'); subs.className='subs';
      subs.innerHTML = `<em>ğŸ”„ ØªØ¹ÙˆÛŒØ¶ÛŒâ€ŒÙ‡Ø§:</em> ${ t.subs.map(s=>s.name).join(' ØŒ ') }`;
      card.appendChild(subs);
    }
    teamsArea.appendChild(card);
  }
}

// register user
joinBtn.addEventListener('click', async () => {
  const name = (nameInput.value || '').trim();
  const role = roleSelect.value;
  if (!name) return showToast('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
  const settingsSnap = await settingsRef.once('value');
  const settings = settingsSnap.val() || {};
  if (!settings.signupOpen) return showToast('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¨Ø³ØªÙ‡ Ø§Ø³Øª.');
  // check if already registered
  const existingSnap = await participantsRef.child(LOCAL_UID).once('value');
  if (existingSnap.exists()) return showToast('Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.');
  // also ensure unique name optional: (not strictly necessary)
  // push
  const data = { name, role, ts: Date.now() };
  await participantsRef.child(LOCAL_UID).set(data);
  nameInput.value = '';
  showToast('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ âœ…');
});

// admin actions
async function ensureAdmin() {
  const v = adminPassInput.value || '';
  if (!v) { showToast('Ø±Ù…Ø² Ø§Ø¯Ù…ÛŒÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return false; }
  if (v !== ADMIN_PASS) { showToast('Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª'); return false; }
  return true;
}

// set teams count
setTeamsBtn.addEventListener('click', async () => {
  if (!await ensureAdmin()) return;
  const num = Number(teamCountSelect.value);
  await settingsRef.update({ teamsCount: num });
  showToast('ØªØ¹Ø¯Ø§Ø¯ ØªÛŒÙ…â€ŒÙ‡Ø§ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯: ' + num);
});

// open/close signup
openSignupBtn.addEventListener('click', async () => {
  if (!await ensureAdmin()) return;
  await settingsRef.update({ signupOpen: true });
  showToast('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§Ø² Ø´Ø¯.');
});
closeSignupBtn.addEventListener('click', async () => {
  if (!await ensureAdmin()) return;
  await settingsRef.update({ signupOpen: false });
  showToast('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø³ØªÙ‡ Ø´Ø¯.');
});

// assign function (core algorithm)
assignBtn.addEventListener('click', async () => {
  if (!await ensureAdmin()) return;
  // read participants and settings
  const [pSnap, sSnap] = await Promise.all([participantsRef.once('value'), settingsRef.once('value')]);
  const participants = pSnap.val() || {};
  const settings = sSnap.val() || {};
  const teamsCount = Number(settings.teamsCount || teamCountSelect.value || 2);

  const list = Object.entries(participants).map(([id,info]) => ({ id, name: info.name, role: info.role }));
  if (list.length === 0) return showToast('Ù‡ÛŒÚ† Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');
  // separate gks and players
  const gks = list.filter(x=>x.role==='gk');
  const players = list.filter(x=>x.role!=='gk');
  if (gks.length < teamsCount) {
    return showToast(`ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†â€ŒÙ‡Ø§ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª â€” Ù„Ø§Ø²Ù… Ø§Ø³Øª Ø­Ø¯Ø§Ù‚Ù„ ${teamsCount} Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù† Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†Ù†Ø¯.`);
  }

  // shuffle
  shuffleArray(gks);
  shuffleArray(players);

  // prepare new teams
  const newTeams = Array.from({length: teamsCount}, ()=>({ members: [], subs: [] }));

  // assign one GK per team
  for (let i=0;i<teamsCount;i++){
    newTeams[i].members.push({ id: gks[i].id, name: gks[i].name, role: 'gk' });
  }

  // now round-robin assign players to keep balanced and max 5 per team
  let idx = 0;
  for (const p of players){
    // try to find a team with members < 5 and minimal size
    // simple approach: try teams in round-robin with modulo
    let assigned = false;
    for (let attempt=0; attempt<teamsCount; attempt++){
      const tIdx = (idx + attempt) % teamsCount;
      if (newTeams[tIdx].members.length < 5) {
        newTeams[tIdx].members.push({ id: p.id, name: p.name, role: 'player' });
        assigned = true; break;
      }
    }
    if (!assigned) {
      // all teams full -> push to team with smallest subs
      let minSubs = Infinity, pick = 0;
      for (let j=0;j<teamsCount;j++){
        if (newTeams[j].subs.length < minSubs) { minSubs = newTeams[j].subs.length; pick = j; }
      }
      newTeams[pick].subs.push({ id: p.id, name: p.name, role: 'player' });
    }
    idx++;
  }

  // ensure difference between teams at most 1 (members only)
  // compute sizes:
  const sizes = newTeams.map(t => t.members.length);
  const minSize = Math.min(...sizes), maxSize = Math.max(...sizes);
  if (maxSize - minSize > 1) {
    // attempt simple rebalancing: move from biggest to smallest while possible
    // (should rarely happen because round-robin)
    for (let iter=0; iter<100; iter++){
      const sizes2 = newTeams.map(t => t.members.length);
      const minI = sizes2.indexOf(Math.min(...sizes2));
      const maxI = sizes2.indexOf(Math.max(...sizes2));
      if (newTeams[maxI].members.length - newTeams[minI].members.length <= 1) break;
      // move last non-GK player from maxI to minI if exists
      const idxm = newTeams[maxI].members.findIndex(m=>m.role!=='gk');
      if (idxm>=0) {
        const [m] = newTeams[maxI].members.splice(idxm,1);
        newTeams[minI].members.push(m);
      } else break;
    }
  }

  // write teams to DB (overwrite)
  // structure: teams: { team0: {members:[...], subs:[...]} }
  const teamsObj = {};
  for (let i=0;i<newTeams.length;i++){
    teamsObj['team' + i] = newTeams[i];
  }
  await teamsRef.set(teamsObj);
  // mark assigned true
  await settingsRef.update({ assignedAt: Date.now(), assigned: true, teamsCount });
  showToast('ØªÛŒÙ…â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù†Ø¯ âœ…');
});

// initial setup: if no settings in DB, create defaults
(async function ensureDefaults(){
  const s = (await settingsRef.once('value')).val();
  if (!s) {
    await settingsRef.set({ teamsCount: 2, signupOpen: true, assigned: false });
  }
})();

// (Optional) admin quick demo: if nobody sets admin pass, you can set ADMIN_PASS above
// End of script
</script>
</body>
</html>
