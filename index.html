<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Random Team</title>
<style>
:root{
  --bg1:#071025;
  --bg2:#030416;
  --blue-1:#2563eb;
  --blue-2:#60a5fa;
  --red-1:#ef4444;
  --green-1:#16a34a;
  --cyan-1:#06b6d4;
  --gold-1:#f59e0b;
  --text:#eaf2ff;
  --card: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family: Vazirmatn, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:
  radial-gradient(800px 300px at 10% 10%, rgba(37,99,235,0.06), transparent 6%),
  radial-gradient(900px 300px at 90% 90%, rgba(34,197,94,0.04), transparent 6%),
  linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
/* splash */
#splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:200;pointer-events:none}
#ball{font-size:110px;animation:spin .5s cubic-bezier(.2,.9,.2,1) both}
@keyframes spin{0%{transform:rotate(0) scale(1);opacity:1}60%{transform:rotate(360deg) scale(1.12);opacity:1}100%{transform:rotate(720deg) scale(1);opacity:0}}
/* bubbles bg */
.bubbles{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.bubble{position:absolute;border-radius:50%;opacity:0.06;filter:blur(10px);animation:float linear infinite}
@keyframes float{0%{transform:translateY(110vh) scale(.6);opacity:0}10%{opacity:.04}50%{opacity:.07}100%{transform:translateY(-30vh) scale(1.1);opacity:0}}

.container{position:relative;z-index:10;min-height:100vh;display:flex;align-items:start;justify-content:center;padding:32px 16px}
.panel{width:100%;max-width:1050px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.18));border-radius:16px;padding:16px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 30px 70px rgba(0,0,0,0.6);backdrop-filter: blur(3px)}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.title{font-weight:900;font-size:20px;background:linear-gradient(90deg,var(--cyan-1),var(--blue-2));-webkit-background-clip:text;background-clip:text;color:transparent}
.count{font-size:13px;color:rgba(255,255,255,0.7)}

/* layout: left (form steps) + right (teams) */
.grid{display:grid;grid-template-columns:420px 1fr;gap:14px}
@media (max-width:920px){ .grid{grid-template-columns:1fr} }

/* Steps area */
.card{background:var(--card);padding:14px;border-radius:12px}
.step{display:none}
.step.active{display:block}
.input{width:100%;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,0.02);color:var(--text);font-size:15px}
.roles{display:flex;gap:10px;margin-top:12px}
.role{flex:1;padding:14px;border-radius:12px;text-align:center;font-weight:900;cursor:pointer;box-shadow:0 10px 20px rgba(2,6,23,0.6);opacity:.85;transition:transform .12s, box-shadow .12s}
.role.player{background:linear-gradient(135deg,var(--blue-1),var(--blue-2)); color:white}
.role.gk{background:linear-gradient(135deg,var(--red-1),#b91c1c); color:white}
.role.active{transform:translateY(-6px);box-shadow:0 20px 40px rgba(2,6,23,0.6);opacity:1}

/* buttons */
.btn{width:100%;padding:14px;border-radius:12px;border:none;font-weight:900;font-size:15px;cursor:pointer;margin-top:12px;box-shadow:0 8px 0 rgba(0,0,0,0.45);transition:transform .08s}
.btn:active{transform:translateY(2px)}
.btn-register{background:linear-gradient(135deg,var(--green-1),var(--cyan-1));color:#012;border-bottom:5px solid rgba(0,0,0,0.35)}
.btn-reset{background:linear-gradient(135deg,var(--gold-1),#fcd34d);color:#3a2a00;border-bottom:5px solid rgba(0,0,0,0.35)}
.btn-shuffle{background:linear-gradient(135deg,#94a3b8,#c7d2fe);color:#012;border-bottom:5px solid rgba(0,0,0,0.25)}

/* teams area */
.teams-wrap{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));min-height:300px}
.teams{display:flex;gap:12px}
.team{flex:1;background:rgba(255,255,255,0.02);border-radius:10px;padding:10px;min-height:180px;overflow:auto}
.team h3{margin:6px 0 10px;font-size:15px}
.ul{list-style:none;padding:0;margin:0}
.li{padding:8px;border-radius:10px;margin:6px 0;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;gap:10px;align-items:center}

/* subs label */
.sub-label{font-size:13px;color:var(--gold-1);margin-top:8px}

/* toast */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(3,6,23,0.9);padding:8px 12px;border-radius:10px;color:#fff;z-index:300;display:none}

/* small screens */
@media (max-width:420px){
  #ball{font-size:80px}
  .grid{gap:10px}
}
</style>
</head>
<body>

<div class="bubbles" id="bubbles"></div>

<div id="splash"><div id="ball">âš½</div></div>

<div class="container">
  <div class="panel" role="main" aria-label="Random Team">

    <div class="header">
      <div class="title">Random Team</div>
      <div class="count" id="count">Û° Ù†ÙØ±</div>
    </div>

    <div class="grid">
      <!-- LEFT: steps -->
      <div class="card" id="stepsArea">
        <!-- Step 1: name -->
        <div class="step" id="step1">
          <input id="nameInput" class="input" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù…â€ŒØ®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ (ÙØ§Ø±Ø³ÛŒ ÛŒØ§ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)" maxlength="40" />
          <button id="btnNext" class="btn btn-register" aria-label="Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯">Ø§Ø¯Ø§Ù…Ù‡</button>
        </div>

        <!-- Step 2: choose role -->
        <div class="step" id="step2">
          <div style="font-weight:900;margin-bottom:8px">Ù†Ù‚Ø´ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†</div>
          <div class="roles">
            <div id="rolePlayer" class="role player" role="button" tabindex="0" aria-pressed="false">âš½ Ø¨Ø§Ø²ÛŒÚ©Ù†</div>
            <div id="roleGk" class="role gk" role="button" tabindex="0" aria-pressed="false">ğŸ§¤ Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†</div>
          </div>
          <button id="btnRegister" class="btn btn-register" aria-label="Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ">Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ</button>
        </div>

        <!-- Hidden small admin area (buttons) -->
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button id="btnShuffle" class="btn btn-shuffle" title="Ø§ÛŒØ¬Ø§Ø¯ Ú†ÛŒÙ†Ø´ Ø´Ø§Ù†Ø³ÛŒ (Ø§Ø¯Ù…ÛŒÙ†)">ğŸ”€ Ù‚Ø§Ø·ÛŒâ€ŒÚ©Ø±Ø¯Ù† (Ø§Ø¯Ù…ÛŒÙ†)</button>
          <button id="btnReset" class="btn btn-reset" title="Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„ (Ø§Ø¯Ù…ÛŒÙ†)">ğŸ” Ø±ÛŒØ³Øª (Ø§Ø¯Ù…ÛŒÙ†)</button>
        </div>
      </div>

      <!-- RIGHT: teams -->
      <div class="teams-wrap">
        <div class="teams" id="teamsArea">
          <div class="team" aria-live="polite">
            <h3>ğŸ”µ ØªÛŒÙ… A</h3>
            <ul id="listA" class="ul"></ul>
            <div class="sub-label">ğŸ”„ ØªØ¹ÙˆÛŒØ¶ÛŒ A</div>
            <ul id="subsA" class="ul"></ul>
          </div>
          <div class="team" aria-live="polite">
            <h3>ğŸ”´ ØªÛŒÙ… B</h3>
            <ul id="listB" class="ul"></ul>
            <div class="sub-label">ğŸ”„ ØªØ¹ÙˆÛŒØ¶ÛŒ B</div>
            <ul id="subsB" class="ul"></ul>
          </div>
        </div>
      </div>
    </div> <!-- grid -->

  </div> <!-- panel -->
</div> <!-- container -->

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  'use strict';

  /* ---------- CONFIG ---------- */
  const ADMIN_PASS = 'admin12345';
  const STORAGE_KEY = 'RT_STATE_V2';      // saved assignments & players
  const DEVICE_KEY = 'RT_DEVICE_V2';      // device id (prevents re-register)
  const TEAMS_COUNT = 2;                  // fixed 2 teams
  const MAX_TEAM_SIZE = 5;                // including GK

  /* ---------- DOM ---------- */
  const splash = document.getElementById('splash');
  const nameInput = document.getElementById('nameInput');
  const btnNext = document.getElementById('btnNext');
  const step1 = document.getElementById('step1');
  const step2 = document.getElementById('step2');
  const rolePlayer = document.getElementById('rolePlayer');
  const roleGk = document.getElementById('roleGk');
  const btnRegister = document.getElementById('btnRegister');
  const btnShuffle = document.getElementById('btnShuffle');
  const btnReset = document.getElementById('btnReset');
  const listA = document.getElementById('listA');
  const listB = document.getElementById('listB');
  const subsA = document.getElementById('subsA');
  const subsB = document.getElementById('subsB');
  const countEl = document.getElementById('count');
  const toastEl = document.getElementById('toast');
  const stepsArea = document.getElementById('stepsArea');

  /* ---------- utils ---------- */
  function toast(msg, ms=1600){
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=>toastEl.style.display='none', ms);
  }
  function devId(){
    try{
      let d = localStorage.getItem(DEVICE_KEY);
      if(!d){ d = Date.now().toString(36) + Math.random().toString(36).slice(2,8); localStorage.setItem(DEVICE_KEY, d); }
      return d;
    } catch(e){ return 'dev-'+Math.random().toString(36).slice(2,8); }
  }
  const DEVICE = devId();

  function saveState(state){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){ console.error('save err', e); } }
  function loadState(){ try{ const s = localStorage.getItem(STORAGE_KEY); return s ? JSON.parse(s) : { players: [] }; }catch(e){ return { players: [] }; } }

  // secure-ish random integer
  function randInt(max){
    try{
      if(window.crypto && crypto.getRandomValues){
        const a = new Uint32Array(1);
        crypto.getRandomValues(a);
        return a[0] % max;
      }
    }catch(e){}
    return Math.floor(Math.random()*max);
  }

  function shuffleArray(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = randInt(i+1);
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  /* ---------- assignment algorithm ---------- */
  // state.players: array of {name, role:'player'|'gk', dev, team, sub}
  function assignAll(state){
    // separate
    const gks = state.players.filter(p => p.role === 'gk').map(p=>({name:p.name,dev:p.dev}));
    const players = state.players.filter(p => p.role !== 'gk').map(p=>({name:p.name,dev:p.dev}));
    shuffleArray(gks);
    shuffleArray(players);

    // init teams
    const teams = Array.from({length:TEAMS_COUNT}, ()=>({members:[], subs:[]}));

    // assign GK per team (if available)
    for(let i=0;i<TEAMS_COUNT;i++){
      if(gks[i]){
        teams[i].members.push({name:gks[i].name, role:'gk', dev:gks[i].dev});
      }
    }
    // assign players round-robin but respect MAX_TEAM_SIZE
    let idx = 0;
    for(const p of players){
      // find team in round-robin order starting at idx with room < MAX_TEAM_SIZE
      let attempts = 0;
      let placed = false;
      while(attempts < TEAMS_COUNT){
        const t = (idx + attempts) % TEAMS_COUNT;
        if(teams[t].members.length < MAX_TEAM_SIZE){
          teams[t].members.push({name:p.name, role:'player', dev:p.dev});
          placed = true; break;
        }
        attempts++;
      }
      if(!placed){
        // all mains full -> put in subs, choose team with smaller subs
        const subsCounts = teams.map(t=>t.subs.length);
        const pick = subsCounts[0] <= subsCounts[1] ? 0 : 1;
        teams[pick].subs.push({name:p.name, role:'player', dev:p.dev});
      }
      idx++;
    }

    // If any team still exceeds MAX_TEAM_SIZE (rare), move extras to subs
    for(const t of teams){
      while(t.members.length > MAX_TEAM_SIZE){
        const moved = t.members.pop();
        t.subs.push(moved);
      }
    }

    // write back into state.players
    const newPlayers = [];
    for(let ti=0;ti<TEAMS_COUNT;ti++){
      for(const m of teams[ti].members){
        newPlayers.push({name:m.name, role:m.role, dev:m.dev, team: ti===0 ? 'A' : 'B', sub: false});
      }
      for(const s of teams[ti].subs){
        newPlayers.push({name:s.name, role:s.role, dev:s.dev, team: ti===0 ? 'A' : 'B', sub: true});
      }
    }
    state.players = newPlayers;
    return state;
  }

  /* ---------- render ---------- */
  function render(){
    const state = loadState();
    // ensure assignment updated
    assignAll(state);
    saveState(state);

    // clear lists
    listA.innerHTML = '';
    listB.innerHTML = '';
    subsA.innerHTML = '';
    subsB.innerHTML = '';

    // fill
    const mainA = state.players.filter(p=>p.team==='A' && !p.sub);
    const mainB = state.players.filter(p=>p.team==='B' && !p.sub);
    const subA = state.players.filter(p=>p.team==='A' && p.sub);
    const subB = state.players.filter(p=>p.team==='B' && p.sub);

    for(const p of mainA){
      const li = document.createElement('li'); li.className='li';
      li.textContent = (p.role==='gk' ? 'ğŸ§¤ ' : 'âš½ ') + p.name;
      listA.appendChild(li);
    }
    for(const p of mainB){
      const li = document.createElement('li'); li.className='li';
      li.textContent = (p.role==='gk' ? 'ğŸ§¤ ' : 'âš½ ') + p.name;
      listB.appendChild(li);
    }
    for(const s of subA){
      const li = document.createElement('li'); li.className='li'; li.textContent = 'ğŸ” ' + s.name; subsA.appendChild(li);
    }
    for(const s of subB){
      const li = document.createElement('li'); li.className='li'; li.textContent = 'ğŸ” ' + s.name; subsB.appendChild(li);
    }

    // update count
    countEl.textContent = state.players.length + ' Ù†ÙØ±';
  }

  /* ---------- step UI logic ---------- */
  function userRegistered(){
    const state = loadState();
    return state.players.some(p => p.dev === DEVICE);
  }

  function showStepsIfNotRegistered(){
    if(userRegistered()){
      // hide steps area fully
      stepsArea.style.display = 'none';
    } else {
      stepsArea.style.display = 'block';
      showStep(1);
    }
  }

  function showStep(n){
    step1.classList.remove('active');
    step2.classList.remove('active');
    if(n===1) step1.classList.add('active');
    if(n===2) step2.classList.add('active');
  }

  /* ---------- event handlers ---------- */
  btnNext.addEventListener('click', ()=>{
    const name = nameInput.value.trim();
    if(!name){ toast('Ù„Ø·ÙØ§Ù‹ Ø§Ø³Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
    showStep(2);
  });

  // role select
  let selectedRole = null;
  function setRole(r){
    selectedRole = r;
    rolePlayer.classList.toggle('active', r==='player');
    roleGk.classList.toggle('active', r==='gk');
    rolePlayer.setAttribute('aria-pressed', r==='player');
    roleGk.setAttribute('aria-pressed', r==='gk');
  }
  rolePlayer.addEventListener('click', ()=> setRole('player'));
  roleGk.addEventListener('click', ()=> setRole('gk'));
  rolePlayer.addEventListener('keydown', (e)=>{ if(e.key==='Enter') setRole('player'); });
  roleGk.addEventListener('keydown', (e)=>{ if(e.key==='Enter') setRole('gk'); });

  // register
  btnRegister.addEventListener('click', ()=>{
    if(userRegistered()){ toast('Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ú©Ø±Ø¯ÛŒØ¯'); showStepsIfNotRegistered(); return; }
    const name = nameInput.value.trim();
    if(!name) { toast('Ø§Ø³Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†'); return; }
    if(!selectedRole) { toast('Ù†Ù‚Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†'); return; }

    // load state and append (temp)
    const state = loadState();
    // prevent duplicates by name or device
    if(state.players.some(p => p.dev === DEVICE)){
      toast('Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡â€ŒØ§ÛŒ');
      showStepsIfNotRegistered();
      return;
    }
    state.players.push({name: name, role: selectedRole, dev: DEVICE});
    assignAll(state);
    saveState(state);

    // hide steps for this device
    showStepsIfNotRegistered();
    render();
    toast('Ø«Ø¨Øª Ø´Ø¯ âœ…');
  });

  // admin shuffle
  btnShuffle.addEventListener('click', ()=>{
    const pass = prompt('Ø±Ù…Ø² Ø§Ø¯Ù…ÛŒÙ†:');
    if(pass === null) return;
    if(pass !== ADMIN_PASS){ toast('Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡'); return; }
    const state = loadState();
    // shuffle order, then reassign
    shuffleArray(state.players);
    assignAll(state);
    saveState(state);
    render();
    toast('ØªÛŒÙ…â€ŒÙ‡Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø´Ø§Ù†Ø³ÛŒ Ø´Ø¯Ù†Ø¯');
  });

  // admin reset
  btnReset.addEventListener('click', ()=>{
    const pass = prompt('Ø±Ù…Ø² Ø§Ø¯Ù…ÛŒÙ†:');
    if(pass === null) return;
    if(pass !== ADMIN_PASS){ toast('Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡'); return; }
    if(!confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù‡Ù…Ù‡ Ú†ÛŒØ² Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ')) return;
    localStorage.removeItem(STORAGE_KEY);
    // DO NOT remove DEVICE_KEY â€” keep per-device registration until admin decides to clear
    // but user wanted full reset; remove device too so everyone can register again:
    localStorage.removeItem(DEVICE_KEY);
    render();
    showStepsIfNotRegistered();
    toast('Ù¾Ø§Ú© Ø´Ø¯');
  });

  /* ---------- init visual extras ---------- */
  // bubbles
  (function makeBubbles(){
    try{
      const root = document.getElementById('bubbles');
      const colors = ['rgba(96,165,250,0.08)','rgba(52,211,153,0.06)','rgba(252,191,73,0.05)','rgba(244,114,182,0.05)'];
      for(let i=0;i<10;i++){
        const b = document.createElement('div');
        b.className = 'bubble';
        const size = 80 + Math.round(Math.random()*260);
        b.style.width = size+'px'; b.style.height = size+'px';
        b.style.left = Math.round(Math.random()*100)+'%';
        b.style.bottom = -(Math.random()*40+10)+'vh';
        b.style.background = colors[i%colors.length];
        b.style.animationDuration = (20 + Math.random()*30)+'s';
        b.style.opacity = (0.02 + Math.random()*0.06).toString();
        root.appendChild(b);
      }
    }catch(e){ console.error(e); }
  })();

  // hide splash after animation
  setTimeout(()=>{ try{ splash && splash.remove(); }catch(e){} }, 700);

  // initial render and ui
  render();
  showStepsIfNotRegistered();

  // expose minor debug (optional)
  window.RT = {
    loadState, saveState, assignAll, render
  };

})();
</script>
</body>
</html>
