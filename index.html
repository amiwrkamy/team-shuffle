<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Team Shuffle â€” Final</title>
<style>
:root{
  --bg1:#041428; --glass: rgba(255,255,255,0.03);
  --accent-a:#38b6ff; --accent-b:#0047b3; --accent-c:#ffd166; --accent-d:#ff5252;
  --card-shadow: 0 18px 40px rgba(2,8,23,0.7);
}
*{box-sizing:border-box;font-family: "Vazirmatn", "Segoe UI", Tahoma, sans-serif}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),#021427);color:#fff; -webkit-font-smoothing:antialiased;}
.app{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}

/* 3D-style container */
.container{
  width:100%;max-width:980px; perspective:1200px;
}
.panel{
  transform-style:preserve-3d;
  border-radius:16px;
  padding:18px;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  box-shadow: var(--card-shadow), 0 6px 18px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
  transform: rotateX(6deg) translateZ(0);
}

/* header minimal */
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.brand{font-weight:900;color:var(--accent-c);letter-spacing:0.6px}
.count{font-weight:700;color:var(--accent-a)}

/* layout */
.grid{display:grid;grid-template-columns:1fr 420px;gap:14px}
@media(max-width:880px){ .grid{grid-template-columns:1fr} }

/* inputs / roles */
.field{margin-bottom:10px}
input[type="text"]{width:100%;padding:12px;border-radius:10px;border:none;background:rgba(255,255,255,0.02);color:inherit;font-size:15px}
.roles{display:flex;gap:8px}
.role{
  flex:1;padding:10px;border-radius:10px;text-align:center;cursor:pointer;
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));
  border:1px solid rgba(255,255,255,0.02);font-weight:800;font-size:14px
}
.role.active{box-shadow:0 10px 28px rgba(3,10,30,0.6);transform:translateY(-4px);border-color:rgba(255,255,255,0.06)}

/* buttons */
.btn{width:100%;padding:12px;border-radius:10px;border:none;font-weight:900;cursor:pointer;margin-top:8px}
.btn.primary{background:linear-gradient(90deg,var(--accent-a),var(--accent-b));color:#021;box-shadow:0 12px 30px rgba(56,182,255,0.12)}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:rgba(255,255,255,0.9)}
.btn.admin{background:linear-gradient(90deg,var(--accent-c),#ffd54f);color:#001}

/* teams boxes */
.teams{display:flex;gap:12px;margin-top:14px}
@media(max-width:880px){ .teams{flex-direction:column} }
.team{
  flex:1;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));
  border-radius:12px;padding:10px;min-height:120px;border:1px solid rgba(255,255,255,0.02)
}
.team h4{margin:0 0 8px;font-size:14px;color:var(--accent-a)}
ul{list-style:none;margin:0;padding:0}
li{
  padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg, rgba(0,0,0,0.14), rgba(255,255,255,0.01));
  font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  display:flex;align-items:center;gap:10px;
}

/* badge style for role */
.badge{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-weight:800;font-size:12px;color:var(--accent-b)}

/* splash/ball animation (squash/stretch bounce) */
.splash{
  position:fixed;inset:0;z-index:60;display:flex;align-items:center;justify-content:center;background:transparent;pointer-events:none;
}
.ball{
  font-size:110px; display:inline-block; transform-origin:center bottom;
  animation:ball-burst .55s cubic-bezier(.2,.9,.2,1) forwards;
  filter:drop-shadow(0 12px 30px rgba(0,0,0,0.6));
}
@keyframes ball-burst{
  0%{transform:translateY(-40vh) scale(1) }
  30%{transform:translateY(6vh) scaleX(1.25) scaleY(.8)} /* squash on impact */
  45%{transform:translateY(-6vh) scaleX(.9) scaleY(1.08)} /* stretch upward */
  60%{transform:translateY(0) scaleX(1.03) scaleY(.98)}
  100%{transform:translateY(0) scale(1)}
}

/* subtle 3D depth on hover for panel (interactive feel) */
.panel:hover{ transform: rotateX(0deg) translateZ(8px) translateY(-6px); transition:transform .32s cubic-bezier(.2,.9,.2,1) }

/* small responsive tweaks */
.small{font-size:12px;color:rgba(255,255,255,0.7)}
</style>
</head>
<body>

<!-- animated ball on entry -->
<div class="splash" id="splash"><div class="ball">âš½</div></div>

<div class="app">
  <div class="container">
    <div class="panel" role="main" aria-label="Team Shuffle">

      <div class="header">
        <div class="brand">Team Shuffle</div>
        <div class="count" id="count">0</div>
      </div>

      <div class="grid">

        <!-- left: controls -->
        <div>
          <div class="field">
            <input id="name" type="text" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù…â€ŒØ®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ (ÙØ§Ø±Ø³ÛŒ/Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)" maxlength="40" autocomplete="name" />
          </div>

          <div class="roles">
            <div id="rolePlayer" class="role" data-role="player">âš½ Ø¨Ø§Ø²ÛŒÚ©Ù†</div>
            <div id="roleGk" class="role" data-role="gk">ğŸ§¤ Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†</div>
          </div>

          <button id="btnRegister" class="btn primary">Ø«Ø¨Øª Ùˆ Ø§Ù†ØªØ®Ø§Ø¨</button>

          <div style="height:10px"></div>

          <button id="btnShuffle" class="btn ghost">ğŸ”€ Ù‚Ø§Ø·ÛŒâ€ŒÚ©Ø±Ø¯Ù† Ø¯ÙˆØ¨Ø§Ø±Ù‡ (Ø§Ø¯Ù…ÛŒÙ†)</button>
          <button id="btnReset" class="btn admin" style="margin-top:8px">ğŸ” Ø±ÛŒØ³Øª (Ø§Ø¯Ù…ÛŒÙ†)</button>
        </div>

        <!-- right: teams -->
        <div>
          <div class="teams">
            <div class="team">
              <h4>ğŸ”µ ØªÛŒÙ… A</h4>
              <ul id="teamA"></ul>
              <div class="small" style="margin-top:6px">ØªØ¹ÙˆÛŒØ¶ÛŒ A</div>
              <ul id="subsA"></ul>
            </div>
            <div class="team">
              <h4>ğŸ”´ ØªÛŒÙ… B</h4>
              <ul id="teamB"></ul>
              <div class="small" style="margin-top:6px">ØªØ¹ÙˆÛŒØ¶ÛŒ B</div>
              <ul id="subsB"></ul>
            </div>
          </div>
        </div>

      </div>

    </div>
  </div>
</div>

<script>
/* ======= Core local-only implementation (no server) =======
 - single file, stores data in localStorage under key TS_V5
 - device-id prevents the same phone/browser from registering twice
 - admin actions require ADMIN_PASS
*/
const ADMIN_PASS = 'admin12345';
const STORAGE_KEY = 'TS_V5';
const DEVICE_KEY = 'TS_DEVICE_V5';

/* device id */
function deviceId(){
  let d = localStorage.getItem(DEVICE_KEY);
  if(!d){ d = Date.now().toString(36) + Math.random().toString(36).slice(2,8); localStorage.setItem(DEVICE_KEY,d); }
  return d;
}
const DEV = deviceId();

/* load/save state */
function load(){ try{ const r = localStorage.getItem(STORAGE_KEY); return r?JSON.parse(r):{players:[]}; }catch(e){return {players:[]};} }
function save(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

let state = load();

/* DOM refs */
const el = {
  name: document.getElementById('name'),
  rolePlayer: document.getElementById('rolePlayer'),
  roleGk: document.getElementById('roleGk'),
  btnRegister: document.getElementById('btnRegister'),
  btnShuffle: document.getElementById('btnShuffle'),
  btnReset: document.getElementById('btnReset'),
  teamA: document.getElementById('teamA'),
  teamB: document.getElementById('teamB'),
  subsA: document.getElementById('subsA'),
  subsB: document.getElementById('subsB'),
  count: document.getElementById('count'),
  splash: document.getElementById('splash')
};

let selectedRole = null;
el.rolePlayer.addEventListener('click', ()=>select('player'));
el.roleGk.addEventListener('click', ()=>select('gk'));

function select(r){
  selectedRole = r;
  el.rolePlayer.classList.toggle('active', r==='player');
  el.roleGk.classList.toggle('active', r==='gk');
}

/* assignment rules (2 teams) */
function assign(player){
  // build current teams
  const teams = { A: [], B: [] };
  const subs = { A: [], B: [] };
  for(const p of state.players){
    if(p.team){
      if(p.sub) subs[p.team].push(p);
      else teams[p.team].push(p);
    }
  }

  // GK handling
  if(player.role === 'gk'){
    const hasA = teams.A.some(x=>x.role==='gk');
    const hasB = teams.B.some(x=>x.role==='gk');
    if(hasA && hasB) return { ok:false, reason:'gks_full' };
    const candidates = [];
    if(!hasA && teams.A.length < 5) candidates.push('A');
    if(!hasB && teams.B.length < 5) candidates.push('B');
    if(candidates.length===0) return { ok:false, reason:'no_space_gk' };
    const pick = candidates[Math.floor(Math.random()*candidates.length)];
    player.team = pick; player.sub = false;
    return { ok:true, team: pick, as:'main' };
  }

  // player role
  const aCount = teams.A.length, bCount = teams.B.length;
  const available = [];
  if(aCount < 5) available.push('A');
  if(bCount < 5) available.push('B');
  if(available.length>0){
    const minMain = Math.min(aCount, bCount);
    const balanced = available.filter(t => (t==='A'?aCount:bCount)===minMain);
    const pick = balanced[Math.floor(Math.random()*balanced.length)];
    player.team = pick; player.sub = false;
    return { ok:true, team: pick, as:'main' };
  }
  // mains full -> subs to smaller subs
  const sa = subs.A.length, sb = subs.B.length;
  const pick = sa <= sb ? 'A' : 'B';
  player.team = pick; player.sub = true;
  return { ok:true, team: pick, as:'sub' };
}

/* register click */
el.btnRegister.addEventListener('click', ()=>{
  const name = (el.name.value||'').trim();
  if(!name) return alert('Ù†Ø§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†');
  if(!selectedRole) return alert('Ù†Ù‚Ø´ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†');
  // device already used?
  if(state.players.some(p=>p.device===DEV)) return alert('Ø§ÛŒÙ† Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ú©Ø±Ø¯Ù‡ Ø§Ø³Øª');
  const player = { id: Date.now().toString(36)+Math.random().toString(36).slice(2,6), name, role:selectedRole, device:DEV };
  const r = assign(player);
  if(!r.ok){
    if(r.reason === 'gks_full') return alert('Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù† Ù‡Ø± Ø¯Ùˆ ØªÛŒÙ… Ù¾Ø± Ø§Ø³Øª');
    if(r.reason === 'no_space_gk') return alert('Ø¬Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
    return alert('Ù‚Ø§Ø¨Ù„ÛŒØª Ø«Ø¨Øª ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
  }
  state.players.push(player);
  save(state);
  render();
  el.name.value=''; selectedRole=null; el.rolePlayer.classList.remove('active'); el.roleGk.classList.remove('active');
}

/* shuffle admin only */
el.btnShuffle.addEventListener('click', ()=>{
  const pass = prompt('Ø±Ù…Ø² Ø§Ø¯Ù…ÛŒÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:');
  if(pass===null) return;
  if(pass !== ADMIN_PASS) return alert('Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
  // perform reshuffle: require at least 2 GK
  const gks = state.players.filter(p=>p.role==='gk');
  if(gks.length < 2) return alert('Ø¨Ø±Ø§ÛŒ Ù‚Ø§Ø·ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø­Ø¯Ø§Ù‚Ù„ 2 Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù† Ù„Ø§Ø²Ù… Ø§Ø³Øª');
  // shuffle arrays
  shuffle(state.players);
  // clear assignments
  for(const p of state.players){ delete p.team; delete p.sub; }
  // reassign GK first
  const gkList = state.players.filter(p=>p.role==='gk');
  for(let i=0;i<2;i++){
    const p = gkList[i];
    if(p){ p.team = i===0?'A':'B'; p.sub = false; }
  }
  // assign remaining randomly while respecting max5 for mains then subs
  const others = state.players.filter(p=>!p.team);
  let rr = 0;
  for(const p of others){
    const aMain = state.players.filter(x=>x.team==='A' && !x.sub).length;
    const bMain = state.players.filter(x=>x.team==='B' && !x.sub).length;
    const prefer = rr%2===0 ? 'A' : 'B';
    const alt = prefer==='A' ? 'B' : 'A';
    if((prefer==='A' && aMain < 5) || (prefer==='B' && bMain < 5)){
      p.team = prefer; p.sub = false;
    } else if((alt==='A' && aMain < 5) || (alt==='B' && bMain < 5)){
      p.team = alt; p.sub = false;
    } else {
      const sa = state.players.filter(x=>x.team==='A' && x.sub).length;
      const sb = state.players.filter(x=>x.team==='B' && x.sub).length;
      p.team = sa <= sb ? 'A' : 'B'; p.sub = true;
    }
    rr++;
  }
  save(state); render(); alert('ØªÛŒÙ…â€ŒÙ‡Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø´Ø§Ù†Ø³ÛŒ Ú†ÛŒØ¯Ù‡ Ø´Ø¯Ù†Ø¯');
});

/* reset admin only */
el.btnReset.addEventListener('click', ()=>{
  const pass = prompt('Ø±Ù…Ø² Ø§Ø¯Ù…ÛŒÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†:');
  if(pass===null) return;
  if(pass !== ADMIN_PASS) return alert('Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
  if(!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒ Ù‡Ù…Ù‡ Ú†ÛŒØ² Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ')) return;
  state = { players: [] };
  save(state);
  // allow re-register by same devices after reset
  localStorage.removeItem(DEVICE_KEY);
  render();
});

/* render */
function render(){
  el.teamA.innerHTML=''; el.teamB.innerHTML=''; el.subsA.innerHTML=''; el.subsB.innerHTML='';
  // ensure assignment for legacy entries
  for(const p of state.players){
    if(!p.team){
      const temp = assign({...p}); p.team = temp.team; p.sub = temp.as==='sub';
    }
  }
  // create lists
  const A_main = state.players.filter(p => p.team==='A' && !p.sub);
  const B_main = state.players.filter(p => p.team==='B' && !p.sub);
  const A_sub = state.players.filter(p => p.team==='A' && p.sub);
  const B_sub = state.players.filter(p => p.team==='B' && p.sub);

  for(const p of A_main) el.teamA.insertAdjacentHTML('beforeend', `<li><span class="badge">${p.role==='gk'?'ğŸ§¤':'âš½'}</span>${escapeHtml(p.name)}</li>`);
  for(const p of B_main) el.teamB.insertAdjacentHTML('beforeend', `<li><span class="badge">${p.role==='gk'?'ğŸ§¤':'âš½'}</span>${escapeHtml(p.name)}</li>`);
  for(const p of A_sub) el.subsA.insertAdjacentHTML('beforeend', `<li>ğŸ” ${escapeHtml(p.name)}</li>`);
  for(const p of B_sub) el.subsB.insertAdjacentHTML('beforeend', `<li>ğŸ” ${escapeHtml(p.name)}</li>`);

  el.count.textContent = `${state.players.length} Ù†ÙØ±`;
}

/* helpers */
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } }
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* splash hide quickly (0.55s) */
setTimeout(()=>{ const s = document.getElementById('splash'); if(s) s.remove(); }, 550);

/* initial render */
render();

</script>
</body>
</html>
